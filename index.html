<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>DMZ: TACTICAL MAP</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* STILE MILITARE/DMZ */
    body { margin: 0; padding: 0; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: #0f0; }
    
    /* LOGIN SCREEN */
    #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    h1 { color: #fff; text-shadow: 0 0 10px #0f0; font-size: 30px; letter-spacing: 2px; margin-bottom: 30px; text-align: center; }
    .input-box { background: #111; border: 1px solid #333; color: #0f0; padding: 15px; margin: 10px; width: 80%; max-width: 300px; text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; }
    .input-box::placeholder { color: #040; }
    .btn-deploy { background: #004400; color: #fff; border: 2px solid #0f0; padding: 15px 40px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 0 15px #0f0; transition: 0.2s; }
    .btn-deploy:active { background: #0f0; color: #000; }

    /* MAPPA E MIRINO CENTRALE */
    #map { height: 100vh; width: 100%; z-index: 1; background: #222; }
    #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0, 255, 0, 0.5); font-size: 30px; font-weight: bold; z-index: 1000; pointer-events: none; text-shadow: 0 0 5px #000; display: none; }

    /* HUD (Interfaccia) */
    #hud-top { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; justify-content: space-between; pointer-events: none; }
    .hud-box { background: rgba(0, 20, 0, 0.9); border: 1px solid #0f0; padding: 5px 10px; color: #0f0; font-weight: bold; font-size: 12px; text-shadow: 0 0 5px #0f0; transition: 0.3s; }
    
    /* PULSANTI STATO */
    #hud-status { position: absolute; top: 50px; left: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 5px; }
    .btn-status { background: rgba(0,0,0,0.8); border: 1px solid #555; color: #fff; padding: 8px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; text-align: left; transition: 0.2s; }
    .btn-status:active { transform: scale(0.95); }

    /* PULSANTI AZIONE (Centro) */
    #hud-bottom { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 20px; }
    .action-btn { background: rgba(0,0,0,0.8); border: 2px solid #fff; color: #fff; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; backdrop-filter: blur(4px); box-shadow: 0 0 10px #000; }
    .action-btn:active { background: #fff; color: #000; }

    /* STILE MARKER E PING */
    .teammate-label { background: transparent; font-weight: bold; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; font-size: 12px; margin-top: -38px; text-align: center; width: 100px; margin-left: -42px; }
    .exfil-icon { text-align: center; font-size: 20px; text-shadow: 0 0 5px #0f0; }
    
    .ping-icon { background: rgba(255, 0, 0, 0.8); border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; box-shadow: 0 0 15px #f00; animation: ping-pulse 1s infinite; }
    @keyframes ping-pulse { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }

    /* AVVISO FUORI AREA */
    #out-of-bounds-warning { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.4); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; }
    .warning-text { color: #fff; background: #f00; padding: 20px; font-size: 30px; font-weight: bold; text-align: center; border: 4px solid #fff; box-shadow: 0 0 30px #f00; animation: flash 1s infinite; }
    @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
</head>
<body>

<div id="login-screen">
    <h1>DMZ: DEPLOY</h1>
    <input type="text" id="p-name" class="input-box" placeholder="NOME OPERATORE">
    <select id="p-team" class="input-box">
        <option value="ALPHA">SQUADRA ALPHA</option>
        <option value="BRAVO">SQUADRA BRAVO</option>
        <option value="CHARLIE">SQUADRA CHARLIE</option>
        <option value="DELTA">SQUADRA DELTA</option>
    </select>
    <button class="btn-deploy" onclick="deploy()">DISPIEGAMENTO</button>
</div>

<div id="map"></div>
<div id="crosshair">‚úõ</div>

<div id="hud-top" style="display:none;">
    <div class="hud-box" id="obj-status">OBIETTIVO: ESTRAZIONE</div>
    <div class="hud-box" id="gps-status">GPS: ATTESA...</div>
</div>

<div id="hud-status" style="display:none;">
    <button class="btn-status" style="border-color:#0f0; color:#0f0;" onclick="setStatus('active', this)">üü¢ IN COMBATTIMENTO</button>
    <button class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('down', this)">üü† DA RIANIMARE</button>
    <button class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('dead', this)">üíÄ ELIMINATO</button>
</div>

<div id="out-of-bounds-warning">
    <div class="warning-text">‚ö†Ô∏è ATTENZIONE ‚ö†Ô∏è<br>SEI FUORI DALLA ZONA OPERATIVA</div>
</div>

<div id="hud-bottom" style="display:none;">
    <div class="action-btn" onclick="centerMap()">üìç</div> 
    <div class="action-btn" onclick="pingLocation()">‚ö†Ô∏è</div> 
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    // Importate anche le funzioni push e onChildAdded per i Ping
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, update, onDisconnect, onValue, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // -----------------------------------------------------------
    // 1. CONFIGURAZIONE FIREBASE
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCggNlC5bOdGVBzUsfX8wO4ygkNzNcFFm0",
        authDomain: "softair-dmz.firebaseapp.com",
        databaseURL: "https://softair-dmz-default-rtdb.firebaseio.com",
        projectId: "softair-dmz",
        storageBucket: "softair-dmz.firebasestorage.app",
        messagingSenderId: "426944578042",
        appId: "1:426944578042:web:c11e7eddd49bbd3bc76443",
        measurementId: "G-8N023X8HSR"
    };
    
    // -----------------------------------------------------------
    // 2. CONFIGURAZIONE CAMPO DA GIOCO
    // -----------------------------------------------------------
    const fieldCenter = [45.679141, 9.896634]; 

    const playAreaCoords = [
        [45.679223271161206, 9.892754719006636],
        [45.679053080947185, 9.894369628150011],
        [45.679488010465164, 9.894333540794852],
        [45.67994184635777, 9.897482162532492],
        [45.67979056813591, 9.89984588429542],
        [45.68035785935887, 9.902110365831659],
        [45.67821215309606, 9.903234794745936],
        [45.67863434946003, 9.896859606506366]
    ];

    const exfilPoints = [
        { lat: 45.680000, lng: 9.896634, label: "EXFIL A" },
        { lat: 45.678000, lng: 9.896634, label: "EXFIL B" } 
    ];

    // -----------------------------------------------------------
    // MATEMATICA: ALGORITMO PER AREA DI GIOCO (RAY-CASTING)
    // -----------------------------------------------------------
    function isInsideArea(point, polygon) {
        let x = point[0], y = point[1];
        let inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
            let xi = polygon[i][0], yi = polygon[i][1];
            let xj = polygon[j][0], yj = polygon[j][1];
            let intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    // -----------------------------------------------------------
    // VARIABILI DI GIOCO
    // -----------------------------------------------------------
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId = "OP_" + Math.floor(Math.random() * 99999);
    let myName = "";
    let myTeam = "";
    let myStatus = "active"; // Stato iniziale
    let uavActive = false;   // Stato UAV
    let map;
    let myMarker = null;
    let markers = {}; 

    // WAKE LOCK (Schermo Sempre Acceso)
    let wakeLock = null;
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock();
    });

    // -----------------------------------------------------------
    // FUNZIONI PRINCIPALI
    // -----------------------------------------------------------

    // AVVIO GIOCO
    window.deploy = function() {
        let n = document.getElementById('p-name').value.trim().toUpperCase();
        if(!n) { alert("Inserisci nome operatore!"); return; }
        
        myName = n;
        myTeam = document.getElementById('p-team').value;
        
        // UI Switch
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('hud-top').style.display = 'flex';
        document.getElementById('hud-status').style.display = 'flex';
        document.getElementById('hud-bottom').style.display = 'flex';
        document.getElementById('crosshair').style.display = 'block'; // Mostra il mirino
        
        requestWakeLock();
        try { document.documentElement.requestFullscreen(); } catch(e){}

        initMap();
        startGPS();
        setupNetworking();
    };

    // CAMBIO STATO
    window.setStatus = function(newStatus, btnElement) {
        myStatus = newStatus;
        update(ref(db, 'dmz_players/' + myId), { status: myStatus });

        // Aggiorna grafica bottoni
        let buttons = document.querySelectorAll('.btn-status');
        buttons.forEach(btn => {
            btn.style.borderColor = "#555";
            btn.style.color = "#fff";
        });
        
        if(newStatus === 'active') { btnElement.style.borderColor = "#0f0"; btnElement.style.color = "#0f0"; }
        if(newStatus === 'down') { btnElement.style.borderColor = "#ffa500"; btnElement.style.color = "#ffa500"; }
        if(newStatus === 'dead') { btnElement.style.borderColor = "#aaa"; btnElement.style.color = "#aaa"; }
    };

    // INIZIALIZZA MAPPA (VISTA IBRIDA)
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView(fieldCenter, 17);
        
        // Mappa Ibrida (Google Maps Satellite + Strade)
        L.tileLayer('http://mt0.google.com/vt/lyrs=y&hl=it&x={x}&y={y}&z={z}', {
            attribution: '¬© Google',
            maxZoom: 20
        }).addTo(map);

        // Disegna perimetro operativo
        L.polygon(playAreaCoords, { color: 'red', fill: false, weight: 3, dashArray: '10, 10' }).addTo(map);

        // Disegna punti di estrazione
        exfilPoints.forEach(ex => {
            let icon = L.divIcon({
                className: 'exfil-icon',
                html: `<div style="background:#0f0; color:#000; font-weight:900; padding:4px 8px; border-radius:4px; border:2px solid #fff; font-family:sans-serif;">üöÅ ${ex.label}</div>`,
                iconSize: [80, 30]
            });
            L.marker([ex.lat, ex.lng], {icon: icon}).addTo(map);
        });
    }

    // TRACCIAMENTO GPS E CONTROLLO CONFINI
    function startGPS() {
        if (!navigator.geolocation) { 
            document.getElementById('gps-status').innerText = "GPS: ERROR";
            return; 
        }

        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const acc = Math.round(pos.coords.accuracy);

                document.getElementById('gps-status').innerText = `GPS: ¬±${acc}m`;

                // Controllo Area DMZ: Sei dentro o fuori?
                let amI_Inside = isInsideArea([lat, lng], playAreaCoords);
                if (!amI_Inside) {
                    document.getElementById('out-of-bounds-warning').style.display = 'flex';
                } else {
                    document.getElementById('out-of-bounds-warning').style.display = 'none';
                }

                // Invia dati su Firebase
                update(ref(db, 'dmz_players/' + myId), {
                    name: myName,
                    team: myTeam,
                    lat: lat,
                    lng: lng,
                    status: myStatus, // Invia stato (Vivo/A terra/Eliminato)
                    lastUpdate: Date.now()
                });

                updateMyMarker(lat, lng);
            },
            (err) => {
                console.error(err);
                document.getElementById('gps-status').innerText = "GPS: NO SEG";
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
    }

    function updateMyMarker(lat, lng) {
        if (!myMarker) {
            let myIcon = L.divIcon({
                className: 'my-icon',
                html: `<div style="width:20px; height:20px; background:cyan; border:3px solid white; border-radius:50%; box-shadow:0 0 15px cyan;"></div>`,
                iconSize: [20, 20]
            });
            myMarker = L.marker([lat, lng], {icon: myIcon}).addTo(map);
            map.setView([lat, lng]); 
        } else {
            myMarker.setLatLng([lat, lng]);
        }
    }

    // RADAR TATTICO E COLLEGAMENTO DATI
    function setupNetworking() {
        // Ascolta stato UAV globale da Firebase
        onValue(ref(db, 'dmz_settings/uav_active'), (snapshot) => {
            uavActive = snapshot.val() || false;
            if(uavActive) {
                document.getElementById('obj-status').innerText = "‚ö†Ô∏è UAV ATTIVO: NEMICI VISIBILI";
                document.getElementById('obj-status').style.color = "#f00";
            } else {
                document.getElementById('obj-status').innerText = "OBIETTIVO: ESTRAZIONE";
                document.getElementById('obj-status').style.color = "#0f0";
            }
        });

        // Ascolta le posizioni degli altri giocatori
        onValue(ref(db, 'dmz_players'), (snapshot) => {
            const players = snapshot.val() || {};
            
            // FASE A: Pulizia Radar (Rimuovi chi non deve essere visibile)
            Object.keys(markers).forEach(key => {
                const p = players[key];
                let shouldBeVisible = false;
                
                if (p) {
                    if (p.team === myTeam) shouldBeVisible = true; // Alleato
                    else if (p.status === "dead") shouldBeVisible = true; // Eliminato
                    else if (uavActive) shouldBeVisible = true; // Nemico svelato da UAV
                }

                if (!shouldBeVisible) {
                    map.removeLayer(markers[key]);
                    delete markers[key];
                }
            });

            // FASE B: Disegno e Aggiornamento Radar
            Object.keys(players).forEach(key => {
                if (key === myId) return; // Ignora te stesso

                const p = players[key];
                let isVisible = false;
                let dotColor = (p.team === myTeam) ? "#0f0" : "#f00"; // Verde (alleato) o Rosso (nemico)
                let iconSymbol = "";

                // Regole Visibilit√†
                if (p.team === myTeam) {
                    isVisible = true; 
                } else if (p.status === "dead") {
                    isVisible = true; 
                } else if (uavActive) {
                    isVisible = true; 
                }

                if (isVisible) {
                    // Modifica colore/icona se ferito o eliminato
                    if (p.status === "down") {
                        dotColor = "#ffa500"; 
                        iconSymbol = "üè•";
                    } else if (p.status === "dead") {
                        dotColor = "#555555"; 
                        iconSymbol = "üíÄ";
                    }

                    let iconHtml = `
                        <div style="width:20px; height:20px; background:${dotColor}; border:2px solid #000; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:12px;">${iconSymbol}</div>
                        <div class="teammate-label" style="color:${dotColor};">${p.name}</div>
                    `;

                    let pIcon = L.divIcon({ className: 'custom-icon', html: iconHtml, iconSize: [20, 20] });

                    if (!markers[key]) {
                        markers[key] = L.marker([p.lat, p.lng], {icon: pIcon}).addTo(map);
                    } else {
                        markers[key].setIcon(pIcon);
                        markers[key].setLatLng([p.lat, p.lng]);
                    }
                }
            });
        });

        // ASCOLTA I PING TATTICI DELLA SQUADRA
        onChildAdded(ref(db, 'dmz_pings'), (snapshot) => {
            const ping = snapshot.val();
            const now = Date.now();
            
            // Ignora i ping pi√π vecchi di 15 secondi
            if (now - ping.timestamp > 15000) return;
            
            // Mostra il ping SOLO se √® della tua squadra
            if (ping.team === myTeam) {
                let pIcon = L.divIcon({
                    className: 'custom-ping',
                    html: `
                        <div style="width:24px; height:24px;" class="ping-icon">‚ö†Ô∏è</div>
                        <div class="teammate-label" style="color:#ff0; text-shadow: 0 0 5px #000; margin-top:-35px; width:150px; margin-left:-65px;">
                            PING: ${ping.sender}
                        </div>
                    `,
                    iconSize: [24, 24]
                });
                
                let pingMarker = L.marker([ping.lat, ping.lng], {icon: pIcon}).addTo(map);
                
                // Rimuovi il ping automaticamente dopo 10 secondi
                setTimeout(() => {
                    if (map.hasLayer(pingMarker)) {
                        map.removeLayer(pingMarker);
                    }
                }, 10000);
            }
        });

        // Disconnessione pulita
        onDisconnect(ref(db, 'dmz_players/' + myId)).remove();
    }

    // PULSANTI EXTRA HUD
    window.centerMap = function() {
        if(myMarker) map.setView(myMarker.getLatLng(), 18);
    };
    
    // INVIO PING TATTICO
    window.pingLocation = function() {
        if (!map) return;
        
        // Prendi le coordinate esatte del centro della mappa (dove punta il mirino)
        const center = map.getCenter();
        
        // Crea un nuovo record nel nodo 'dmz_pings'
        const pingRef = push(ref(db, 'dmz_pings'));
        update(pingRef, {
            team: myTeam,
            lat: center.lat,
            lng: center.lng,
            sender: myName,
            timestamp: Date.now()
        });

        // Feedback visivo rapido sul tuo HUD
        document.getElementById('obj-status').innerText = "PING INVIATO!";
        document.getElementById('obj-status').style.color = "#ff0";
        setTimeout(() => { 
            document.getElementById('obj-status').innerText = uavActive ? "‚ö†Ô∏è UAV ATTIVO: NEMICI VISIBILI" : "OBIETTIVO: ESTRAZIONE"; 
            document.getElementById('obj-status').style.color = uavActive ? "#f00" : "#0f0";
        }, 2000);
    };

</script>
</body>
</html>
