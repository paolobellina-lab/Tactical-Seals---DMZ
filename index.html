<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>DMZ: TACTICAL MAP v38.1 - MASTER FIX</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* STILE MILITARE/DMZ */
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    
    body { margin: 0; padding: 0; background: #000; font-family: 'Share Tech Mono', 'Courier New', monospace; overflow: hidden; color: #0f0; }
    
    /* SCHERMATE (LOGIN / MASTER) */
    .full-screen-ui { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at center, #0a150a 0%, #000 100%); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    h1 { color: #fff; text-shadow: 0 0 15px #0f0, 0 0 5px #0f0; font-size: 36px; letter-spacing: 4px; margin-bottom: 5px; text-align: center; }
    .version-tag { color: #0a0; font-size: 14px; margin-bottom: 20px; font-weight: bold; letter-spacing: 2px; }
    
    .status-label { font-size: 18px; font-weight: bold; margin-bottom: 20px; padding: 10px; border: 1px solid #f00; color: #f00; text-align: center; width: 80%; max-width: 300px; background: rgba(255,0,0,0.1); clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
    .status-label.running { border-color: #0f0; color: #0f0; background: rgba(0,255,0,0.1); }

    .input-box { background: rgba(0, 20, 0, 0.8); border: 1px solid #0f0; color: #0f0; padding: 15px; margin: 8px; width: 80%; max-width: 300px; text-align: center; font-size: 16px; font-family: 'Share Tech Mono', monospace; text-transform: uppercase; clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px); transition: 0.3s; outline: none; }
    
    .btn-deploy { background: linear-gradient(135deg, #004400 0%, #001100 100%); color: #0f0; border: 1px solid #0f0; padding: 15px 40px; font-size: 18px; font-family: 'Share Tech Mono', monospace; cursor: pointer; margin-top: 15px; box-shadow: 0 0 10px rgba(0,255,0,0.2); transition: 0.2s; width: 80%; max-width: 300px; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); text-transform: uppercase; letter-spacing: 1px; }
    .btn-deploy:active { background: #0f0; color: #000; box-shadow: 0 0 20px #0f0; }

    .btn-master { background: transparent; border: 1px solid #555; color: #aaa; padding: 10px; margin-top: 30px; font-size: 12px; cursor: pointer; width: 60%; max-width: 200px; font-family: 'Share Tech Mono', monospace; clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px); }

    /* MAPPA */
    #map { height: 100vh; width: 100vw; z-index: 1; background: #111; position: absolute; top:0; left:0; }
    
    /* ROTAZIONE MAPPA CSS */
    .rotated-east {
        transform: rotate(-90deg);
        transform-origin: center center;
        width: 100vh !important;
        height: 100vw !important;
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        margin-top: -50vw !important;
        margin-left: -50vh !important;
    }

    #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0, 255, 0, 0.6); font-size: 30px; font-weight: bold; z-index: 1000; pointer-events: none; text-shadow: 0 0 5px #000; display: none; font-family: sans-serif; }

    /* HUD SUPERIORE */
    #hud-top-container { position: absolute; top: 0; left: 0; width: 100%; z-index: 1000; display: flex; flex-direction: column; pointer-events: none; }
    #obj-banner { width: 100%; background: rgba(0, 15, 0, 0.85); border-bottom: 2px solid #0f0; padding: 10px 0; color: #0f0; font-weight: bold; font-size: 16px; text-shadow: 0 0 8px #0f0; text-align: center; letter-spacing: 1px; backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    #hud-sub-top { display: flex; justify-content: space-between; padding: 10px; width: calc(100% - 20px); }
    .hud-box { background: rgba(0, 20, 0, 0.7); border: 1px solid #0f0; padding: 6px 12px; color: #0f0; font-size: 12px; text-shadow: 0 0 5px #0f0; backdrop-filter: blur(4px); clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px); box-shadow: 0 0 5px rgba(0,255,0,0.2); }
    .hud-economy { background: linear-gradient(135deg, rgba(0,40,0,0.9) 0%, rgba(0,15,0,0.9) 100%); cursor: pointer; pointer-events: auto; font-size: 14px; font-weight: bold; }

    /* COMBAT LOG */
    #combat-log { position: absolute; top: 120px; right: 10px; width: 65%; max-width: 280px; display: flex; flex-direction: column; gap: 5px; align-items: flex-end; z-index: 1000; pointer-events: none; }
    .log-entry { background: rgba(0, 15, 0, 0.85); border-right: 3px solid #0f0; color: #fff; padding: 6px 10px; font-size: 11px; font-family: 'Share Tech Mono', monospace; text-shadow: 0 0 3px #000; clip-path: polygon(8px 0, 100% 0, 100% 100%, 0 100%, 0 8px); animation: slideIn 0.4s ease-out; backdrop-filter: blur(2px); text-align: right; }
    .log-entry span.time { color: #0ff; margin-right: 5px; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

    /* HUD LATERALE E INFERIORE */
    #hud-status { position: absolute; top: 110px; left: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    .btn-status { background: rgba(0,10,0,0.8); border: 1px solid #555; color: #fff; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 12px; cursor: pointer; text-align: left; transition: 0.2s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); backdrop-filter: blur(4px); pointer-events: auto; }
    
    #hud-bottom { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 20px; pointer-events: auto; }
    .action-btn { background: rgba(0,20,0,0.85); border: 2px solid #0f0; color: #0f0; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; backdrop-filter: blur(5px); box-shadow: 0 0 15px rgba(0,255,0,0.3); transition: 0.2s; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); }
    .action-btn:active { background: #0f0; color: #000; transform: scale(0.9); box-shadow: 0 0 25px #0f0; }
    .action-btn.btn-scanner { border-color: #0ff; color: #0ff; box-shadow: 0 0 15px rgba(0,255,255,0.4); }

    /* STILE MARKER MINIMALE */
    .base-marker-container { position:relative; width:30px; height:30px; display:flex; justify-content:center; align-items:center; }
    .base-circle { background:rgba(255,255,0,0.9); border:2px solid #000; border-radius:50%; width:20px; height:20px; display:flex; justify-content:center; align-items:center; color:#000; font-family:'Share Tech Mono', sans-serif; font-weight:bold; font-size:10px; box-shadow:0 0 8px #ff0; }
    .base-name { position:absolute; top:24px; width:120px; text-align:center; color:#ff0; font-size:10px; font-weight:bold; text-shadow:1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; letter-spacing:1px; white-space:nowrap; pointer-events: none; }
    
    .exfil-circle { background:rgba(0,255,255,0.9); border:2px solid #000; border-radius:50%; width:24px; height:24px; display:flex; justify-content:center; align-items:center; font-size:12px; box-shadow:0 0 8px #0ff; }
    .exfil-name { position:absolute; top:28px; width:100px; text-align:center; color:#0ff; font-size:10px; font-weight:bold; text-shadow:1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; pointer-events: none; }

    .teammate-label { background: rgba(0,0,0,0.7); color: #fff; font-family: sans-serif; font-weight: bold; border-radius: 3px; padding: 2px 4px; font-size: 10px; margin-top: -38px; text-align: center; width: 100px; margin-left: -42px; border: 1px solid #555; pointer-events: none; }

    /* EFFETTI A SCHERMO */
    #gas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(200, 0, 255, 0.15); z-index: 999; display: none; pointer-events: none; box-shadow: inset 0 0 100px rgba(200,0,255,0.9); }
    #cuav-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0, 50, 0, 0.1), rgba(0, 50, 0, 0.1) 2px, transparent 2px, transparent 4px); backdrop-filter: blur(8px) grayscale(100%); z-index: 999; display: none; pointer-events: none; }
    #emp-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #050000; z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; color: #f00; font-family: monospace; font-size: 24px; font-weight: bold; text-align: center; text-shadow: 0 0 20px #f00; }
    #revive-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 40, 0, 0.95); z-index: 6000; display: none; flex-direction: column; justify-content: center; align-items: center; color: #0f0; font-family: 'Share Tech Mono', monospace; font-size: 24px; text-align: center; text-shadow: 0 0 15px #0f0; }
</style>
</head>
<body>

<div id="login-screen" class="full-screen-ui">
    <h1>DMZ: DEPLOY</h1>
    <div class="version-tag">SYSTEM v38.1 - MASTER UI FIX</div>
    
    <div id="status-label" class="status-label">CONNESSIONE...</div>
    
    <input type="text" id="p-name" class="input-box" placeholder="NOME SULLA PATCH (es: VIPER)">
    <select id="p-team" class="input-box">
        <option value="ALPHA">SQUADRA ALPHA</option><option value="BRAVO">SQUADRA BRAVO</option>
        <option value="CHARLIE">SQUADRA CHARLIE</option><option value="DELTA">SQUADRA DELTA</option>
    </select>
    
    <div id="start-gear-selection" style="display:none; width:80%; max-width:300px; margin-top:15px; border:1px solid #0cf; padding:15px; background:rgba(0, 20, 30, 0.8); clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);">
        <div style="color:#0cf; font-size:14px; font-weight:bold; margin-bottom:15px; text-align:center; letter-spacing:1px;" id="start-gear-title">SELEZIONA EQUIP. AGGIUNTIVO</div>
        <div id="start-gear-options" style="display:flex; flex-direction:column; gap:8px; max-height:120px; overflow-y:auto;"></div>
    </div>

    <button class="btn-deploy" style="background:linear-gradient(135deg, #003344 0%, #001122 100%); border-color:#0cf; box-shadow: 0 0 10px rgba(0,255,255,0.3); margin-top:10px; color:#0cf;" onclick="openStash()">üè¶ ACCEDI AL MAGAZZINO</button>

    <div id="deploy-help" style="color:#ff0; font-size:12px; margin-top:15px; letter-spacing:1px;">Attendi l'avvio della partita dal Comando.</div>
    <button id="btn-deploy" class="btn-deploy" onclick="deploy()" style="display:none;">DISPIEGAMENTO</button>
    <button class="btn-master" onclick="openMasterPanel()">‚öôÔ∏è PANNELLO MASTER</button>
</div>

<div id="master-screen" class="full-screen-ui" style="display:none; z-index: 2500; overflow-y: auto; padding: 40px 0; justify-content: flex-start;">
    <h1 style="color: #ff0; text-shadow: 0 0 10px #ff0; margin-top:20px;">SISTEMA MASTER</h1>
    <div class="cfg-label" style="width:80%; max-width:300px; margin-top:10px;">CAMPO OPERATIVO:</div>
    <select id="m-field" class="input-box" style="border-color: #ff0; color: #ff0;"><option value="campo1">CAMPO 1: DMZ ORIGINALE</option><option value="campo2">CAMPO 2: ZONA URBANA</option><option value="campo5">CAMPO 5: TEST LOCALE</option></select>
    
    <div class="toggle-row"><span style="color:#ffa500; font-weight:bold;">SISTEMA MEDICO E SQUADRE üè•</span><label class="switch"><input type="checkbox" id="cfg-medic-toggle" checked onchange="toggleMedicMenu()"><span class="slider"></span></label></div>
    <div id="medic-settings" class="cfg-box" style="display:flex;"><div class="cfg-label" style="color:#ffa500; font-weight:bold;">MAX GIOCATORI PER SQUADRA:</div><input type="number" id="cfg-team-size" class="input-box" style="width:100%; margin:0; padding:8px;" value="4"><div class="cfg-label" style="margin-top:10px;">TEMPO DISSANGUAMENTO (SECONDI):</div><input type="number" id="cfg-medic-bleedout" class="input-box" style="width:100%; margin:0; padding:8px;" value="60"><div class="cfg-label" style="margin-top:10px;">MAX CURE CONSENTITE (DA FERITO):</div><input type="number" id="cfg-medic-cures" class="input-box" style="width:100%; margin:0; padding:8px;" value="2"><div class="cfg-label">MAX RIANIMAZIONI (DA MORTO/ASSIMILAZIONE):</div><input type="number" id="cfg-medic-revives" class="input-box" style="width:100%; margin:0; padding:8px;" value="1"></div>
    <div class="toggle-row" style="border-color:#0cf;"><span style="color:#0cf; font-weight:bold;">FORNITURA INIZIALE (BONUS) üéí</span></div>
    <div class="cfg-box" style="display:flex; border-color:#0cf; border-top:1px solid #0cf;"><div class="cfg-label">MODALIT√Ä DI ASSEGNAZIONE:</div><select id="cfg-start-mode" class="input-box" style="width:100%; margin:0; padding:8px; font-size:12px; border-color:#0cf; color:#0cf;" onchange="updateStartModeUI()"><option value="none">NESSUNO (Solo Magazzino Personale)</option><option value="fixed">FISSO (Bonus a tutti)</option><option value="choice">A SCELTA (Bonus a scelta)</option></select><div id="cfg-start-limit-box" style="display:none; margin-top:10px;"><div class="cfg-label">OGGETTI MASSIMI SELEZIONABILI:</div><input type="number" id="cfg-start-limit" class="input-box" style="width:100%; margin:0; padding:8px; border-color:#0cf;" value="2" min="1" max="5"></div><div style="display:flex; gap:5px; margin-bottom:5px; margin-top:10px;"><input type="text" id="start-name" class="input-box" style="width:60%; margin:0; padding:5px; font-size:10px;" placeholder="OGGETTO"><input type="number" id="start-value" class="input-box" style="width:40%; margin:0; padding:5px; font-size:10px; border-color:#8f8; color:#8f8;" placeholder="VALORE $"></div><button class="btn-deploy" style="background:#033; border-color:#0cf; font-size:12px; padding:8px; margin:0;" onclick="addStartGearItem()">+ AGGIUNGI IN LISTA</button><div id="start-gear-list" style="margin-top:10px; border-top:1px solid #444; padding-top:10px; max-height:150px; overflow-y:auto;"></div></div>
    <div class="toggle-row"><span style="color:#f0f; font-weight:bold;">ZONA GAS ‚ò¢Ô∏è</span><label class="switch"><input type="checkbox" id="cfg-gas-toggle" onchange="toggleGasMenu()"><span class="slider"></span></label></div>
    <div id="gas-settings" class="cfg-box"><div class="toggle-row" style="margin-top:0; border:none; padding:0; width:100%;"><span style="color:#f0f; font-size:12px;">GAS LETALE</span><label class="switch"><input type="checkbox" id="cfg-gas-lethal" checked><span class="slider"></span></label></div><div class="cfg-label" style="margin-top:10px;">TEMPO SOPRAVVIVENZA SENZA MASCHERA (SEC):</div><input type="number" id="cfg-gas-time" class="input-box" style="width:100%; margin:0; padding:8px;" value="30"><div class="toggle-row" style="margin-top:10px; border:none; padding:0; width:100%;"><span style="color:#f0f; font-size:12px; max-width:70%;">MOSTRA NEMICI CHE TOSSISCONO NEL GAS</span><label class="switch"><input type="checkbox" id="cfg-gas-vis" checked><span class="slider"></span></label></div><div class="cfg-label" style="margin-top:10px;">NUMERO RESTRINGIMENTI AREA (STEP):</div><input type="number" id="cfg-gas-steps" class="input-box" style="width:100%; margin:0; padding:8px;" value="3"><div class="cfg-label">INTERVALLO TRA STEP (MINUTI):</div><input type="number" id="cfg-gas-interval" class="input-box" style="width:100%; margin:0; padding:8px;" value="10"></div>
    <div class="toggle-row"><span style="color:#e6e6fa; font-weight:bold;">CONTRATTI BASI (B) üìú</span><label class="switch"><input type="checkbox" id="cfg-contracts-toggle" checked onchange="toggleContractsMenu()"><span class="slider"></span></label></div>
    <div id="contracts-settings" class="cfg-box cfg-checkbox-list" style="display:flex;"><label><input type="checkbox" class="contract-cb" value="INTEL" checked> RECUPERO DATI SEGRETI</label><label><input type="checkbox" class="contract-cb" value="DESTROY" checked> DISTRUZIONE SCORTE</label><label><input type="checkbox" class="contract-cb" value="CARGO" checked> CONSEGNA MATERIALE (DROP)</label><label><input type="checkbox" class="contract-cb" value="HUNT" checked> CACCIA ALLA SQUADRA (PvP)</label></div>
    <div class="toggle-row"><span style="color:#8f8; font-weight:bold;">SISTEMA ECONOMICO E CHIAVI üíµ</span><label class="switch"><input type="checkbox" id="cfg-eco-toggle" checked><span class="slider"></span></label></div>
    <div class="toggle-row"><span style="color:#0aa; font-weight:bold;">NEGOZI E KILLSTREAKS üõí</span><label class="switch"><input type="checkbox" id="cfg-shops-toggle" checked onchange="toggleShopMenu()"><span class="slider"></span></label></div>
    <div id="shop-settings" class="cfg-box" style="display:flex;"><div class="cfg-label">LISTINO PREZZI NEGOZIO:</div><div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" id="shop-name" class="input-box" style="width:60%; margin:0; padding:5px; font-size:10px;" placeholder="OGGETTO"><input type="number" id="shop-price" class="input-box" style="width:40%; margin:0; padding:5px; font-size:10px; border-color:#8f8; color:#8f8;" placeholder="PREZZO $"></div><button class="btn-deploy" style="background:#333; border-color:#aaa; font-size:12px; padding:8px; margin:0;" onclick="addShopItem()">+ AGGIUNGI IN VENDITA</button><div id="shop-list" style="margin-top:10px; border-top:1px solid #444; padding-top:10px; max-height:150px; overflow-y:auto; font-family:'Share Tech Mono', monospace;"></div></div>
    <div class="toggle-row"><span style="color:#e6b800; font-weight:bold;">ARMADIETTI E LOOT (A) üì¶</span><label class="switch"><input type="checkbox" id="cfg-lockers-toggle" checked onchange="toggleLockerMenu()"><span class="slider"></span></label></div>
    <div id="locker-settings" class="cfg-box" style="display:flex;"><div class="cfg-label" style="color:#8f8; font-weight:bold; margin-top:10px;">PROBABILIT√Ä DENARO (Somma = 100%):</div><div style="display:flex; gap:5px; margin-bottom:5px;"><input type="number" id="money-amount" class="input-box" style="width:50%; margin:0; padding:5px; font-size:10px; color:#8f8; border-color:#8f8;" placeholder="IMPORTO $"><input type="number" id="money-chance" class="input-box" style="width:50%; margin:0; padding:5px; font-size:10px;" placeholder="% CHANCE"></div><button class="btn-deploy" style="background:#030; border-color:#0f0; font-size:12px; padding:8px; margin:0;" onclick="addMoneyItem()">+ AGGIUNGI PACCHETTO DENARO</button><div id="money-list" style="margin-top:10px; border-top:1px dashed #8f8; padding-top:10px; max-height:100px; overflow-y:auto;"></div><div class="cfg-label" style="color:#e6b800; font-weight:bold; margin-top:20px;">PROBABILIT√Ä OGGETTI (Somma = 100%):</div><div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" id="loot-name" class="input-box" style="width:40%; margin:0; padding:5px; font-size:10px;" placeholder="NOME OGGETTO"><input type="number" id="loot-chance" class="input-box" style="width:25%; margin:0; padding:5px; font-size:10px;" placeholder="%"><input type="number" id="loot-value" class="input-box" style="width:35%; margin:0; padding:5px; font-size:10px; border-color:#8f8; color:#8f8;" placeholder="VALORE $"></div><button class="btn-deploy" style="background:#330; border-color:#ff0; font-size:12px; padding:8px; margin:0;" onclick="addLootItem()">+ AGGIUNGI OGGETTO</button><div id="loot-list" style="margin-top:10px; border-top:1px dashed #ff0; padding-top:10px; max-height:150px; overflow-y:auto;"></div></div>
    <div class="toggle-row"><span style="color:#0ff; font-weight:bold;">ESFILTRAZIONE (E/C) üöÅ</span><label class="switch"><input type="checkbox" id="cfg-exfil-toggle" checked onchange="toggleExfilMenu()"><span class="slider"></span></label></div>
    <div id="exfil-settings" class="cfg-box" style="display:flex;"><div class="cfg-label">NUMERO DI PUNTI ATTIVI:</div><input type="number" id="cfg-exfil-num" class="input-box" style="width:100%; margin:0; padding:8px;" value="2" min="1" max="10"><div class="cfg-label">POSIZIONE ESTRAZIONI:</div><select id="cfg-exfil-pos" class="input-box" style="width:100%; margin:0; padding:8px; font-size:14px;"><option value="defined">C: Punti Mappa Standard</option><option value="random">E: Punti Casuali (Sceglie Basi in area)</option></select><div class="cfg-label">TEMPO ARRIVO ELICOTTERO (MINUTI):</div><input type="number" id="cfg-exfil-wait" class="input-box" style="width:100%; margin:0; padding:8px;" value="2" min="0" max="10"></div>
    <button class="btn-deploy" style="background:#004400; border-color:#0f0; margin-top:40px;" onclick="masterStartGame()">üöÄ AVVIA PARTITA</button>
    <button class="btn-deploy" style="background:rgba(255,0,0,0.2); border-color:#f00; margin-top:20px;" onclick="masterStopGame()">‚èπ TERMINA PARTITA</button>
    <button class="btn-master" style="margin-bottom: 50px;" onclick="closeMasterPanel()">TORNA AL LOGIN</button>
</div>

<div id="stash-modal" class="game-modal">
    <div class="modal-title" style="color:#0cf; text-shadow:0 0 10px #0cf;">MAGAZZINO SEGRETO</div>
    <div class="modal-desc" style="color:#0cf;">Gestisci equipaggiamento.</div>
    <div style="display:flex; width:95%; max-width: 400px; gap:10px; height: 50%;">
        <div class="locker-panel" style="border-color:#0cf;"><h3 style="color:#0cf; border-color:#0cf;">STASH</h3><div id="stash-money-box" style="margin-bottom:10px; padding:5px; background:rgba(0,30,30,0.8); border:1px solid #0cf; clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);"></div><div id="stash-items-box"></div></div>
        <div class="locker-panel"><h3 style="color:#8f8; border-color:#8f8;">ZAINO</h3><div id="stash-loadout-money" style="margin-bottom:10px; padding:5px; background:rgba(0,40,0,0.8); border:1px solid #0f0; clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);"></div><div id="stash-loadout-items"></div></div>
    </div>
    <button class="btn-close-modal" style="border-color:#0cf;" onclick="closeStash()">CHIUDI E SALVA</button>
</div>

<div id="scanner-modal" class="game-modal">
    <div class="modal-title">SCANSIONE OTTICA</div>
    <div class="modal-desc">Inquadra QR o inserisci codice.</div>
    <div id="qr-reader"></div>
    <div style="display:flex; width: 90%; max-width: 350px; gap: 5px; margin-top: 15px;">
        <input type="text" id="manual-code-input" class="input-box" placeholder="ES: B5" style="width:70%; font-size:18px; border-color:#0ff; color:#0ff; margin:0;">
        <button class="btn-deploy" style="width:30%; background:linear-gradient(135deg, #004444 0%, #001111 100%); border-color:#0ff; box-shadow: 0 0 10px rgba(0,255,255,0.4); margin:0; padding:10px;" onclick="processScannedCode()">INVIA</button>
    </div>
    <button class="btn-close-modal" onclick="closeScanner()">ANNULLA SCANSIONE</button>
</div>

<div id="player-action-modal" class="game-modal">
    <div class="modal-title" style="color:#fff;">OPERATORE RILEVATO</div>
    <div class="modal-desc" id="pam-desc" style="color:#aaa; font-size:14px; margin-bottom:30px;">Scegli l'azione tattica.</div>
    <button class="btn-deploy" style="background:linear-gradient(135deg, #005500 0%, #002200 100%); border-color:#0f0; width:90%; max-width:300px; margin-bottom:15px;" onclick="executePlayerAction('REVIVE')">üíâ RIANIMA E ASSIMILA</button>
    <button class="btn-deploy" style="background:linear-gradient(135deg, #550000 0%, #220000 100%); border-color:#f00; width:90%; max-width:300px;" onclick="executePlayerAction('LOOT')">üéí DEPREDA ZAINO</button>
    <button class="btn-close-modal" style="border-color:#555; color:#aaa; margin-top:40px;" onclick="closePlayerAction()">ANNULLA</button>
</div>

<div id="locker-modal" class="game-modal">
    <div class="modal-title" id="locker-title" style="color:#e6b800;">CONTENITORE</div>
    <div style="display:flex; width:95%; max-width: 400px; gap:10px; height: 60%;">
        <div class="locker-panel"><h3 id="locker-left-title" style="color:#e6b800; border-color:#e6b800;">CONTENUTO</h3><div id="locker-money-box" style="margin-bottom:10px; padding:5px; background:rgba(40,30,0,0.8); border:1px solid #e6b800; clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);"></div><div id="locker-items-box"></div></div>
        <div class="locker-panel"><h3 style="color:#8f8; border-color:#8f8;">IL TUO ZAINO</h3><div id="locker-backpack-box"></div></div>
    </div>
    <button class="btn-close-modal" style="border-color:#e6b800;" onclick="closeLocker()">CHIUDI SPORTELLO</button>
</div>

<div id="shop-modal" class="game-modal">
    <div class="modal-title" style="color:#0aa;">MERCATO NERO</div>
    <div id="shop-items-container" style="width:100%; display:flex; flex-direction:column; align-items:center; overflow-y:auto; max-height:60%;"></div>
    <button class="btn-close-modal" style="border-color:#0aa;" onclick="closeShop()">ESCI DAL NEGOZIO</button>
</div>

<div id="backpack-modal" class="game-modal">
    <div class="modal-title" style="color:#8f8;">IL TUO ZAINO</div>
    <div class="modal-desc" id="bp-desc" style="color:#8f8;">Capacit√†: 5 slot</div>
    <div id="bp-items-container" style="width:100%; display:flex; flex-direction:column; align-items:center; overflow-y:auto; max-height:60%;"></div>
    <button class="btn-close-modal" style="border-color:#8f8;" onclick="closeBackpack()">CHIUDI ZAINO</button>
</div>

<div id="revive-overlay">
    üè• RIANIMAZIONE...<br><br><span id="revive-timer" style="font-size: 60px; color:#fff;">10</span>s<br><br>
    <button class="btn-deploy" style="background:#500; border-color:#f00; margin-top:40px;" onclick="cancelRevive()">INTERROMPI</button>
</div>

<div id="map"></div>
<div id="gas-overlay"></div>
<div id="cuav-overlay"></div>
<div id="crosshair">‚úõ</div>

<div id="hud-top-container" style="display:none;">
    <div id="obj-banner">OBIETTIVO: SOPRAVVIVENZA</div>
    <div id="hud-sub-top">
        <div class="hud-box" id="gps-status" style="color:#0ff; border-color:#0ff;">GPS: RICERCA...</div>
        <div id="hud-economy-box" class="hud-box hud-economy" style="display:none;" onclick="openBackpack()">
            <span id="txt-cash">üíµ $0</span>&nbsp;|&nbsp;<span id="txt-bp">üéí 0/5</span>
        </div>
    </div>
</div>

<div id="combat-log"></div>

<div id="hud-status" style="display:none;">
    <button id="btn-status-active" class="btn-status" style="border-color:#0f0; color:#0f0;" onclick="manualSetStatus('active')">üü¢ IN COMBATTIMENTO</button>
    <button id="btn-status-down" class="btn-status" style="border-color:#555; color:#fff;" onclick="manualSetStatus('down')">üü† A TERRA (FERITO)</button>
    <button id="btn-status-dead" class="btn-status" style="border-color:#555; color:#fff;" onclick="manualSetStatus('dead')">üíÄ ELIMINATO (MORTO)</button>
</div>

<div id="hud-bottom" style="display:none;">
    <div class="action-btn" onclick="centerMap()">üìç</div> 
    <div class="action-btn" style="border-color:#ff0; color:#ff0; box-shadow: 0 0 15px rgba(255,255,0,0.3);" onclick="toggleMapRotation()">üß≠</div>
    <div class="action-btn btn-scanner" onclick="openScanner()">üì∑</div> 
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, update, set, onDisconnect, onValue, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCggNlC5bOdGVBzUsfX8wO4ygkNzNcFFm0", authDomain: "softair-dmz.firebaseapp.com", databaseURL: "https://softair-dmz-default-rtdb.firebaseio.com", projectId: "softair-dmz" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const masterBasesDB = [
        { id: "B1", name: "CHIRINGUITO", lat: 45.679325, lng: 9.895191 },
        { id: "B2", name: "BANCA", lat: 45.679668, lng: 9.896275 },
        { id: "B3", name: "BUCO NERO", lat: 45.679326, lng: 9.897387 },
        { id: "B4", name: "PRATI BASSI", lat: 45.679367, lng: 9.899083 },
        { id: "B5", name: "LABORATORIO", lat: 45.679264, lng: 9.900673 },
        { id: "B6", name: "PRATI ALTI", lat: 45.680613, lng: 9.900875 },
        { id: "B7", name: "ANFITEATRO", lat: 45.679424, lng: 9.90205 },
        { id: "B8", name: "AVAMPOSTO 8", lat: 45.679779, lng: 9.894188 },
        { id: "B9", name: "AVAMPOSTO 9", lat: 45.67905, lng: 9.895674 },
        { id: "B10", name: "AVAMPOSTO 10", lat: 45.679973, lng: 9.899075 },
        { id: "B11", name: "AVAMPOSTO 11", lat: 45.680284, lng: 9.894652 },
        { id: "B12", name: "AVAMPOSTO 12", lat: 45.679344, lng: 9.894223 },
        { id: "B13", name: "AVAMPOSTO 13", lat: 45.678937, lng: 9.89779 },
        { id: "B14", name: "AVAMPOSTO 14", lat: 45.678553, lng: 9.895491 },
        { id: "B15", name: "AVAMPOSTO 15", lat: 45.6798, lng: 9.898087 },
        { id: "B16", name: "AVAMPOSTO 16", lat: 45.678941, lng: 9.898419 },
        { id: "B17", name: "AVAMPOSTO 17", lat: 45.680119, lng: 9.894049 },
        { id: "B18", name: "AVAMPOSTO 18", lat: 45.680112, lng: 9.899236 },
        { id: "B19", name: "AVAMPOSTO 19", lat: 45.679181, lng: 9.895166 },
        { id: "B20", name: "AVAMPOSTO 20", lat: 45.680414, lng: 9.896524 }
    ];

    const fieldsDB = {
        "campo1": { 
            center: [45.6795, 9.8975], 
            boundaries: [ [45.679223, 9.892754], [45.679053, 9.894369], [45.678634, 9.896859], [45.678212, 9.903234], [45.680357, 9.902110], [45.679790, 9.899845], [45.679941, 9.897482], [45.679488, 9.894333] ], 
            exfils: [ { id: "C1", lat: 45.6800, lng: 9.8966, label: "EXFIL C1" } ] 
        },
        "campo2": { 
            center: [45.000, 9.000], boundaries: [[45.001, 8.999], [45.001, 9.001], [44.999, 9.001], [44.999, 8.999]], exfils: [] 
        },
        "campo5": { 
            center: [45.699417, 9.827667], boundaries: [[45.7014, 9.8256], [45.7014, 9.8296], [45.6974, 9.8296], [45.6974, 9.8256]], exfils: [] 
        }
    };
    
    const customTrails = [
        [ [45.679254, 9.894659], [45.679155, 9.894616], [45.679045, 9.894601], [45.678974, 9.894686], [45.678905, 9.894783], [45.678883, 9.894916], [45.678878, 9.895047], [45.678874, 9.895188], [45.678818, 9.895301], [45.678726, 9.89537], [45.678711, 9.895502], [45.678697, 9.895634], [45.678662, 9.895759], [45.678653, 9.895891], [45.678658, 9.896032], [45.678656, 9.896185], [45.678637, 9.896324], [45.678618, 9.896461], [45.678601, 9.896583], [45.678583, 9.896723], [45.678545, 9.896851], [45.678537, 9.89698], [45.678551, 9.897095], [45.678587, 9.897218], [45.678678, 9.897221], [45.678769, 9.897257], [45.678871, 9.897279], [45.678966, 9.897274], [45.67905, 9.897353], [45.679033, 9.897488], [45.679005, 9.89762], [45.679004, 9.897748], [45.679052, 9.897872], [45.679101, 9.897985], [45.679107, 9.898127], [45.679148, 9.898234], [45.679151, 9.898097], [45.679167, 9.897998], [45.67917, 9.897997], [45.679166, 9.897857], [45.679153, 9.89771], [45.679173, 9.897574], [45.679215, 9.897456], [45.679307, 9.897391], [45.679361, 9.8973], [45.67935, 9.897313], [45.679287, 9.897407], [45.679348, 9.897502], [45.679422, 9.897549], [45.679419, 9.897693], [45.679432, 9.897835], [45.679436, 9.897974], [45.679419, 9.898103], [45.679487, 9.898186], [45.679525, 9.898306], [45.679472, 9.898418], [45.679495, 9.898493], [45.679447, 9.898609], [45.679417, 9.898737], [45.679393, 9.898872], [45.679365, 9.899006], [45.67939, 9.898881], [45.679384, 9.898736], [45.679423, 9.898599], [45.679492, 9.898527], [45.679585, 9.898575], [45.679614, 9.898449], [45.679631, 9.898315], [45.679659, 9.898186], [45.679687, 9.898051], [45.679689, 9.897904], [45.679713, 9.897766], [45.679715, 9.897646], [45.679741, 9.897508], [45.679761, 9.897362], [45.679763, 9.897224], [45.679728, 9.897093], [45.679658, 9.897034], [45.679624, 9.89691], [45.679602, 9.896783], [45.67951, 9.89679], [45.67944, 9.896882], [45.679419, 9.896839], [45.679437, 9.896704], [45.679445, 9.896571], [45.679476, 9.896437], [45.679513, 9.896348], [45.679599, 9.89628], [45.679642, 9.896152], [45.679718, 9.896172], [45.679701, 9.896032], [45.679618, 9.895956], [45.679527, 9.895901], [45.679497, 9.895764], [45.679551, 9.895635], [45.679548, 9.895495], [45.679504, 9.895382], [45.679423, 9.895337], [45.679392, 9.895249], [45.679356, 9.89513], [45.679379, 9.89512], [45.679313, 9.895011], [45.679271, 9.894875], [45.679233, 9.894743] ],
        [ [45.678797, 9.894583], [45.678889, 9.894589], [45.678983, 9.894581], [45.679035, 9.894487], [45.679068, 9.894349], [45.679154, 9.894316], [45.679221, 9.894413], [45.67928, 9.894526], [45.679321, 9.89465], [45.679301, 9.894781], [45.679354, 9.894894], [45.679408, 9.894999], [45.679399, 9.895125], [45.67946, 9.895219], [45.679441, 9.895343], [45.679487, 9.895286], [45.679506, 9.89536], [45.679557, 9.895436], [45.679557, 9.89557], [45.679496, 9.895675], [45.679483, 9.895814], [45.679571, 9.895868], [45.679645, 9.895954], [45.679685, 9.896094], [45.679673, 9.896231], [45.679641, 9.896366], [45.679586, 9.896477], [45.679488, 9.896479], [45.679506, 9.896374], [45.679487, 9.896387], [45.679502, 9.896534], [45.679544, 9.896647], [45.679634, 9.896692], [45.679662, 9.896813], [45.679672, 9.896959], [45.679713, 9.897099], [45.679713, 9.897218], [45.679699, 9.897225], [45.679744, 9.897145], [45.679795, 9.897256], [45.679753, 9.897381], [45.679758, 9.897522], [45.679743, 9.897675], [45.679718, 9.897813], [45.679707, 9.897963], [45.679687, 9.898098], [45.679673, 9.8982], [45.679633, 9.898321], [45.679629, 9.898478], [45.679616, 9.898608], [45.679528, 9.898563], [45.679438, 9.898581], [45.679419, 9.898713], [45.679398, 9.898851], [45.679349, 9.898952], [45.679362, 9.898824], [45.679392, 9.898676], [45.679431, 9.89855], [45.679526, 9.898552], [45.679609, 9.898539], [45.67963, 9.89838], [45.679658, 9.898227], [45.679386, 9.898987], [45.679388, 9.899132], [45.679362, 9.899275], [45.679332, 9.899415], [45.679332, 9.899555], [45.679322, 9.899696], [45.679319, 9.899833], [45.679347, 9.899964], [45.679393, 9.900085], [45.679401, 9.900235], [45.679335, 9.900313], [45.679268, 9.90041], [45.679276, 9.900547], [45.679239, 9.900678], [45.679288, 9.900789], [45.679353, 9.9007], [45.679301, 9.900821], [45.679319, 9.9008], [45.679288, 9.900869], [45.679275, 9.900977], [45.679345, 9.900876], [45.679337, 9.90087], [45.679276, 9.900959], [45.679241, 9.900832], [45.679188, 9.900847], [45.679228, 9.90087], [45.679208, 9.900734], [45.679248, 9.900765], [45.679206, 9.900638], [45.679128, 9.900567], [45.679026, 9.900563], [45.679037, 9.900473], [45.67904, 9.900448], [45.679023, 9.90039], [45.678938, 9.900307], [45.678899, 9.900199], [45.678853, 9.900072], [45.67884, 9.899942], [45.678836, 9.899787], [45.678838, 9.899758], [45.678806, 9.899659], [45.678819, 9.899527], [45.678813, 9.899403], [45.678851, 9.899289], [45.678876, 9.89937], [45.678919, 9.89932], [45.67897, 9.899227], [45.678962, 9.899249], [45.678933, 9.899205], [45.678926, 9.899227], [45.679005, 9.899153], [45.67898, 9.899206], [45.678969, 9.899144], [45.67893, 9.899015], [45.678967, 9.898892], [45.678943, 9.898773], [45.678998, 9.898657], [45.679045, 9.898532], [45.67908, 9.898393], [45.679056, 9.898259], [45.679091, 9.898286], [45.679065, 9.898216], [45.679065, 9.898201], [45.679075, 9.898057], [45.679049, 9.897973], [45.678982, 9.89789], [45.678965, 9.897765], [45.678945, 9.897643], [45.678977, 9.897523], [45.679029, 9.897394], [45.678947, 9.897317], [45.678852, 9.897311], [45.678761, 9.897289], [45.678667, 9.89725], [45.678569, 9.89721], [45.678497, 9.897133], [45.678537, 9.897016], [45.678504, 9.896882], [45.678507, 9.89674], [45.67853, 9.896587], [45.678544, 9.896452], [45.67855, 9.89632], [45.678581, 9.896191], [45.678573, 9.896057], [45.678569, 9.895922], [45.678589, 9.895819], [45.678635, 9.895702], [45.678632, 9.895564], [45.678658, 9.895428], [45.678719, 9.895325], [45.678794, 9.895237], [45.678804, 9.89511], [45.678797, 9.89497], [45.678826, 9.894831], [45.67887, 9.894718], [45.678858, 9.894625], [45.678767, 9.894578], [45.678866, 9.894595], [45.678966, 9.894563], [45.678997, 9.894432], [45.678924, 9.894322], [45.67889, 9.894194], [45.678865, 9.894063], [45.678809, 9.893955], [45.67878, 9.893831], [45.67877, 9.893694], [45.678753, 9.893542], [45.678711, 9.893412], [45.678624, 9.893406], [45.678634, 9.893402], [45.678715, 9.893332], [45.678811, 9.893348], [45.67889, 9.893446], [45.678957, 9.893569], [45.679019, 9.893706], [45.679046, 9.89384], [45.679037, 9.893978], [45.679035, 9.894119], [45.679062, 9.894258], [45.679147, 9.894329] ]
    ];

    let activeFieldCenter = [], activePlayAreaCoords = [], activeBases = [], currentExfilPoints = [];

    let myId = ""; let myName = "", myTeam = "", myStatus = "active", myCash = 0, myBackpack = [];
    let myStash = { cash: 0, items: [] }; 
    let map, myMarker = null, markers = {}; 
    let isDeployed = false, bleedoutTimer = null, localUAVActive = false, isTargetingAirstrike = false;
    let myContract = null, exfilTimerEnd = null; window.bleedoutEndTime = null;
    let isMapRotated = false;

    let globalSettings = { status: 'lobby' }; let activeStreaks = {};

    window.logEvent = function(msg) { push(ref(db, 'dmz_logs'), { msg: msg, timestamp: Date.now() }); };

    function isInsideArea(p, poly) { let x = p[0], y = p[1], inside = false; for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) { let intersect = ((poly[i][1] > y) != (poly[j][1] > y)) && (x < (poly[j][0] - poly[i][0]) * (y - poly[i][1]) / (poly[j][1] - poly[i][1]) + poly[i][0]); if (intersect) inside = !inside; } return inside; }

    onValue(ref(db, 'dmz_settings'), (snapshot) => {
        let data = snapshot.val(); if(data) globalSettings = data;
        let sl = document.getElementById('status-label'); let bd = document.getElementById('btn-deploy');
        if (globalSettings.status === 'running') {
            sl.innerText = "üü¢ PARTITA IN CORSO"; sl.className = "status-label running"; bd.style.display = "block";
        } else {
            sl.innerText = "üî¥ IN ATTESA DEL MASTER"; sl.className = "status-label"; bd.style.display = "none";
            if (isDeployed) { alert("Partita Terminata!"); window.location.reload(); }
        }
    });

    onValue(ref(db, 'dmz_streaks'), (snap) => {
        activeStreaks = snap.val() || {};
        if(activeStreaks.airstrikes && map) {
            Object.keys(activeStreaks.airstrikes).forEach(k => { let s = activeStreaks.airstrikes[k]; if (Date.now() < s.timestamp + 20000) { if (!window.strikeCircles) window.strikeCircles = {}; if (!window.strikeCircles[k]) { window.strikeCircles[k] = L.circle([s.lat, s.lng], {color: 'red', fillColor: '#f00', fillOpacity: 0.4, radius: 20}).addTo(map); try { navigator.vibrate([200,100,200,100,200]); }catch(e){} } } });
            if(window.strikeCircles) { Object.keys(window.strikeCircles).forEach(k => { if(!activeStreaks.airstrikes[k] || Date.now() > activeStreaks.airstrikes[k].timestamp + 20000) { map.removeLayer(window.strikeCircles[k]); delete window.strikeCircles[k]; } }); }
        }
    });

    window.deploy = function() {
        try {
            let n = document.getElementById('p-name').value.trim().toUpperCase(); if(!n) return alert("Inserisci il Nome Operatore!"); 
            let reqTeam = document.getElementById('p-team').value; let maxP = globalSettings.team_config ? globalSettings.team_config.maxPlayers : 4;

            get(ref(db, 'dmz_players')).then((snap) => {
                let players = snap.val() || {}; let count = 0; Object.keys(players).forEach(k => { if(players[k].team === reqTeam && players[k].status !== 'exfil') count++; });
                if(count >= maxP) return alert(`ERRORE: La squadra ${reqTeam} √® al completo (Max ${maxP}).`);
                
                myName = n; myTeam = reqTeam; let safeName = myName.replace(/[^A-Z0-9]/g, ''); myId = "OP_" + safeName; 

                let selectedField = fieldsDB[globalSettings.activeField] || fieldsDB["campo1"];
                activeFieldCenter = selectedField.center; activePlayAreaCoords = selectedField.boundaries; 
                if(globalSettings.exfil_config && globalSettings.exfil_config.position === 'random' && globalSettings.exfil_config.points) { currentExfilPoints = globalSettings.exfil_config.points; } else { currentExfilPoints = selectedField.exfils; }
                
                activeBases = masterBasesDB.filter(b => isInsideArea([b.lat, b.lng], activePlayAreaCoords));
                
                let maxC = globalSettings.medic_config ? globalSettings.medic_config.maxCures : 2; let maxR = globalSettings.medic_config ? globalSettings.medic_config.maxRevives : 1;
                document.getElementById('login-screen').style.display = 'none'; document.getElementById('hud-top-container').style.display = 'flex'; document.getElementById('hud-status').style.display = 'flex'; document.getElementById('hud-bottom').style.display = 'flex'; document.getElementById('crosshair').style.display = 'block'; 
                isDeployed = true; 
                
                update(ref(db, 'dmz_players/' + myId), { name: myName, team: myTeam, status: 'active', cash: myCash, backpack: myBackpack, cures_left: maxC, revives_left: maxR, lastUpdate: Date.now() });
                
                initMap(); startGPS(); setupNetworking(); logEvent(`ü™Ç ${myName} (Sq. ${myTeam}) schierato nell'AO.`);
            });
        } catch (error) { alert("ERRORE DI SISTEMA INTERNO: " + error.message); }
    };

    window.manualSetStatus = function(newStatus) {
        if (myStatus === 'dead') return alert("Sei eliminato. Non puoi cambiare stato da solo.");
        if (myStatus === 'down' && newStatus === 'active') return alert("Sei ferito e in dissanguamento! Curati o attendi un compagno.");
        setStatus(newStatus);
    };

    window.setStatus = function(newStatus, btnElement) {
        if (myStatus === 'down' && newStatus === 'dead') alert("Eliminato. Attendi alleato/nemico per rianimazione.");
        myStatus = newStatus; update(ref(db, 'dmz_players/' + myId), { status: myStatus }); document.querySelectorAll('.btn-status').forEach(btn => { btn.style.borderColor = "#555"; btn.style.color = "#fff"; });
        if(!btnElement) btnElement = document.getElementById('btn-status-' + newStatus); 
        if(btnElement) { btnElement.style.borderColor = (newStatus==='active')?"#0f0":(newStatus==='down')?"#ffa500":"#aaa"; btnElement.style.color = btnElement.style.borderColor; }
        if (newStatus === 'exfil') document.getElementById('hud-status').style.display = 'none';
        
        if (bleedoutTimer) { clearTimeout(bleedoutTimer); bleedoutTimer = null; window.bleedoutEndTime = null; }
        if (newStatus === 'dead' || newStatus === 'down') { if (myContract && myContract.type === 'DESTROY') myContract = null; exfilTimerEnd = null; }
        if (newStatus === 'down' && globalSettings.medic_config && globalSettings.medic_config.active) { let boTime = globalSettings.medic_config.bleedout_time || 60; window.bleedoutEndTime = Date.now() + (boTime * 1000); } else { window.bleedoutEndTime = null; }
    };

    window.toggleMapRotation = function() {
        let mapEl = document.getElementById('map');
        isMapRotated = !isMapRotated;
        if(isMapRotated) {
            mapEl.classList.add('rotated-east');
            logEvent("üß≠ Mappa ruotata a Est.");
        } else {
            mapEl.classList.remove('rotated-east');
            logEvent("üß≠ Mappa allineata a Nord.");
        }
        setTimeout(() => { map.invalidateSize(); centerMap(); }, 300);
    };

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView(activeFieldCenter, 17); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', maxZoom: 19 }).addTo(map); 
        L.polygon(activePlayAreaCoords, { color: 'red', fill: false, weight: 3, dashArray: '10, 10' }).addTo(map);
        
        customTrails.forEach(trail => {
            L.polyline(trail, {color: '#fff', weight: 3, opacity: 0.7, dashArray: '5, 5'}).addTo(map);
        });

        activeBases.forEach(b => { 
            let baseLabel = b.name ? b.name : b.id;
            let iconHtml = `
                <div class="base-marker-container">
                    <div class="base-circle">${b.id.replace('B','')}</div>
                    <div class="base-name">${baseLabel}</div>
                </div>`;
            L.marker([b.lat, b.lng], {icon: L.divIcon({ className: 'base-icon', html: iconHtml, iconSize: [30, 30], iconAnchor: [15, 15] }) }).addTo(map); 
        });
        
        if (globalSettings.exfil_config && globalSettings.exfil_config.enabled) {
            let maxPoints = globalSettings.exfil_config.numPoints || currentExfilPoints.length;
            currentExfilPoints.slice(0, maxPoints).forEach(ex => { 
                let iconHtml = `
                <div class="base-marker-container">
                    <div class="exfil-circle">üöÅ</div>
                    <div class="exfil-name">${ex.label}</div>
                </div>`;
                L.marker([ex.lat, ex.lng], {icon: L.divIcon({ className: 'exfil-icon', html: iconHtml, iconSize: [30, 30], iconAnchor: [15, 15] }) }).addTo(map); 
            });
        }
    }

    function startGPS() {
        if (!navigator.geolocation) { let gs = document.getElementById('gps-status'); if(gs) gs.innerText = "GPS: NON SUPP."; return; }
        navigator.geolocation.watchPosition((pos) => {
            if(myStatus === 'exfil') return;
            const lat = pos.coords.latitude, lng = pos.coords.longitude; 
            let gs = document.getElementById('gps-status'); if(gs) { gs.innerText = `GPS: ¬±${Math.round(pos.coords.accuracy)}m`; gs.style.color = "#0ff"; }
            let iHaveCargo = myBackpack.some(i => i.name === "CARICO PESANTE"); let inGasSicuro = window.lastGasStatus === true ? true : false; 

            update(ref(db, 'dmz_players/' + myId), { name: myName, team: myTeam, lat: lat, lng: lng, status: myStatus, in_gas: inGasSicuro, has_cargo: iHaveCargo, lastUpdate: Date.now() }).catch(e => {});
            if (!myMarker) { myMarker = L.marker([lat, lng], {icon: L.divIcon({ className: 'my-icon', html: `<div style="width:20px; height:20px; background:cyan; border:3px solid white; border-radius:50%; box-shadow:0 0 15px cyan;"></div>`, iconSize: [20, 20] }) }).addTo(map); map.setView([lat, lng], 18); } else { myMarker.setLatLng([lat, lng]); }
        }, (err) => {
            let gs = document.getElementById('gps-status');
            if(gs) { gs.style.color = "#f00"; if(err.code === 1) gs.innerText = "GPS: NEGATO"; else if(err.code === 2) gs.innerText = "GPS: NO SEGNALE"; else if(err.code === 3) gs.innerText = "GPS: TIMEOUT"; }
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 });
    }

    setInterval(() => {
        if(!isDeployed || !map || myStatus === 'exfil') return; let now = Date.now();
        
        if (exfilTimerEnd) { if (myStatus !== 'active') { exfilTimerEnd = null; } else if (Math.ceil((exfilTimerEnd - now) / 1000) <= 0) { exfilTimerEnd = null; doExfil(); } }
        if (myContract && myContract.type === 'DESTROY' && myContract.state === 'ARMED') { if (myStatus !== 'active') { myContract = null; } else if (Math.ceil((myContract.endTime - now) / 1000) <= 0) { alert("BOOM! Scorte distrutte!\n+$10000"); myCash += 10000; myContract = null; logEvent(`üí• Scorte distrutte.`); } }

        let inGas = false; let gasRemain = 0;
        if(globalSettings.gas_config && globalSettings.gas_config.enabled) {
            let conf = globalSettings.gas_config; let centerLL = L.latLng(activeFieldCenter[0], activeFieldCenter[1]);
            let stepsTaken = Math.floor(((now - conf.startTime) / 60000) / conf.interval); if(stepsTaken > conf.steps) stepsTaken = conf.steps;
            let maxR = 0; activePlayAreaCoords.forEach(p => { let d = centerLL.distanceTo(L.latLng(p[0], p[1])); if(d > maxR) maxR = d; }); let currentRadius = maxR * (1 - (stepsTaken / conf.steps)); if(currentRadius < 10) currentRadius = 10;
            if(!window.safeZoneCircle) { window.safeZoneCircle = L.circle(centerLL, {color:'#f0f', weight:2, fillOpacity:0.05, dashArray:'5,5'}).addTo(map); } else { window.safeZoneCircle.setRadius(currentRadius); }
            if(myMarker) {
                inGas = centerLL.distanceTo(myMarker.getLatLng()) > currentRadius;
                document.getElementById('gas-overlay').style.display = inGas ? 'block' : 'none';
                if (inGas && conf.lethal && myStatus === 'active') {
                    let maxTime = conf.survivalTime; if(myBackpack.some(i => i.name.includes("AVANZATA"))) maxTime += 120; else if(myBackpack.some(i => i.name.includes("COMPLETA"))) maxTime += 60; else if(myBackpack.some(i => i.name.includes("SEMPLICE"))) maxTime += 30;
                    window.gasExposure = (window.gasExposure || 0) + 1; gasRemain = maxTime - window.gasExposure;
                    if (gasRemain <= 0) { alert("Filtri esauriti. Sei a terra!"); setStatus('down'); }
                } else if (!inGas) { window.gasExposure = 0; }
                if (window.lastGasStatus !== inGas) { window.lastGasStatus = inGas; update(ref(db, 'dmz_players/' + myId), { in_gas: inGas }); }
            }
        } else { document.getElementById('gas-overlay').style.display = 'none'; if(window.safeZoneCircle) { map.removeLayer(window.safeZoneCircle); window.safeZoneCircle = null; } }

        if (myStatus === 'down' && window.bleedoutEndTime) { if (Math.ceil((window.bleedoutEndTime - now) / 1000) <= 0) { window.bleedoutEndTime = null; setStatus('dead'); } }

        let osText = (globalSettings.exfil_config && globalSettings.exfil_config.enabled) ? "OBIETTIVO: ESTRAZIONE" : "OBIETTIVO: SOPRAVVIVENZA"; let osColor = "#0f0";
        if (globalSettings.uav_active || localUAVActive) { osText = "‚ö†Ô∏è UAV ATTIVO"; osColor = "#f00"; }
        if (myContract) { osText = `CONTRATTO ATTIVO`; osColor = "#ff0"; }
        if (myContract && myContract.type === 'DESTROY' && myContract.state === 'ARMED') { let r = Math.ceil((myContract.endTime - now) / 1000); if (r > 0) { osText = `üí£ DETONAZIONE: ${r}s`; osColor = "#ff0"; } }
        if (exfilTimerEnd) { let r = Math.ceil((exfilTimerEnd - now) / 1000); if (r > 0) { osText = `üöÅ ESTRAZIONE: ${r}s`; osColor = "#0ff"; } }
        if (inGas) { if (globalSettings.gas_config && globalSettings.gas_config.lethal && myStatus === 'active') { osText = `‚ò¢Ô∏è GAS: ${gasRemain}s`; osColor = "#f0f"; } else if (globalSettings.gas_config && !globalSettings.gas_config.lethal) { osText = `‚ò¢Ô∏è ZONA CONTAMINATA`; osColor = "#f0f"; } }
        
        if (myStatus === 'down') { if (window.bleedoutEndTime) { let r = Math.ceil((window.bleedoutEndTime - now) / 1000); osText = `ü©∏ DISSANGUAMENTO: ${r}s`; osColor = "#ffa500"; } else { osText = `ü©∏ IN ATTESA MEDICO`; osColor = "#ffa500"; }
        } else if (myStatus === 'dead') { osText = `üíÄ ELIMINATO`; osColor = "#f00"; } else if (myStatus === 'exfil') { osText = `‚úÖ ESTRATTO`; osColor = "#0f0"; }

        let ob = document.getElementById('obj-banner'); if(ob) { ob.innerText = osText; ob.style.color = osColor; ob.style.borderColor = osColor; ob.style.textShadow = `0 0 10px ${osColor}`; }

    }, 1000);

    function setupNetworking() {
        onValue(ref(db, 'dmz_players/' + myId), (snap) => {
            if (snap.exists() && isDeployed && myStatus !== 'exfil') {
                let data = snap.val();
                if (data.status === 'active' && myStatus !== 'active') { myStatus = 'active'; document.querySelectorAll('.btn-status').forEach(btn => { btn.style.borderColor = "#555"; btn.style.color = "#fff"; }); let btnElement = document.getElementById('btn-status-active'); if(btnElement) { btnElement.style.borderColor = "#0f0"; btnElement.style.color = "#0f0"; } if (bleedoutTimer) { clearTimeout(bleedoutTimer); bleedoutTimer = null; window.bleedoutEndTime = null; } alert("Sei stato curato/rianimato da un Operatore!"); }
            }
        });

        onValue(ref(db, 'dmz_players'), (snap) => {
            if(!isDeployed) return; const players = snap.val() || {}; let isUAV = globalSettings.uav_active || localUAVActive;
            Object.keys(markers).forEach(k => { 
                let p = players[k]; let isGasVis = p && p.in_gas && globalSettings.gas_config && globalSettings.gas_config.visibility;
                if(!p || p.status === 'exfil' || (p.team !== myTeam && p.status !== "dead" && !isUAV && !isGasVis && !p.has_cargo)) { map.removeLayer(markers[k]); delete markers[k]; } 
            });

            Object.keys(players).forEach(k => {
                if (k === myId) return; const p = players[k]; if (p.status === 'exfil') return;
                let isGasVis = p.in_gas && globalSettings.gas_config && globalSettings.gas_config.visibility;
                if (p.team === myTeam || p.status === "dead" || isUAV || isGasVis || p.has_cargo) {
                    let c = (p.team===myTeam)?"#0f0":"#f00", s = ""; 
                    if(p.status==="down"){c="#ffa500";s="üè•";} else if(p.status==="dead"){c="#555";s="üíÄ";} else if(p.has_cargo && p.team!==myTeam){c="#ff0";s="üì¶";}
                    let ic = L.divIcon({ className:'custom-icon', html:`<div style="width:20px;height:20px;background:${c};border:2px solid #000;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:12px;">${s}</div><div class="teammate-label" style="color:${c};">${p.name}</div>`, iconSize:[20,20] });
                    if(!markers[k]) markers[k] = L.marker([p.lat, p.lng], {icon:ic}).addTo(map); else { markers[k].setIcon(ic); markers[k].setLatLng([p.lat, p.lng]); }
                }
            });
        });
        
        onChildAdded(ref(db, 'dmz_logs'), (snapshot) => {
            if(!isDeployed) return; let data = snapshot.val(); if (Date.now() - data.timestamp > 300000) return; 
            let logBox = document.getElementById('combat-log'); let div = document.createElement('div');
            let d = new Date(data.timestamp); let timeStr = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
            div.className = "log-entry"; div.innerHTML = `<span class="time">[${timeStr}]</span> ${data.msg}`; logBox.appendChild(div);
            if(logBox.children.length > 5) logBox.removeChild(logBox.firstChild); 
            setTimeout(() => { if (div.parentNode === logBox) { logBox.removeChild(div); } }, 15000);
        });

        onChildAdded(ref(db, 'dmz_pings'), (snapshot) => {
            if(!isDeployed) return; const ping = snapshot.val();
            if (Date.now() - ping.timestamp <= 15000 && ping.team === myTeam) { let pingMarker = L.marker([ping.lat, ping.lng], {icon: L.divIcon({ className: 'custom-ping', html: `<div style="width:24px; height:24px;" class="ping-icon">‚ö†Ô∏è</div><div class="teammate-label" style="color:#ff0; margin-top:-35px; width:150px; margin-left:-65px;">PING: ${ping.sender}</div>`, iconSize: [24, 24] }) }).addTo(map); setTimeout(() => { if (map.hasLayer(pingMarker)) map.removeLayer(pingMarker); }, 10000); }
        });
        onDisconnect(ref(db, 'dmz_players/' + myId)).remove();
    }
    window.centerMap = function() { if(myMarker) map.setView(myMarker.getLatLng(), 18); };
</script>
</body>
</html>
