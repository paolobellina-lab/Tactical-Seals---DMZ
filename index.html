<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>DMZ: TACTICAL MAP</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* STILE MILITARE/DMZ */
    body { margin: 0; padding: 0; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: #0f0; }
    
    /* LOGIN SCREEN */
    #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    h1 { color: #fff; text-shadow: 0 0 10px #0f0; font-size: 30px; letter-spacing: 2px; margin-bottom: 30px; text-align: center; }
    .input-box { background: #111; border: 1px solid #333; color: #0f0; padding: 15px; margin: 10px; width: 80%; max-width: 300px; text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; }
    .input-box::placeholder { color: #040; }
    .btn-deploy { background: #004400; color: #fff; border: 2px solid #0f0; padding: 15px 40px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 0 15px #0f0; transition: 0.2s; }
    .btn-deploy:active { background: #0f0; color: #000; }

    /* MAPPA */
    #map { height: 100vh; width: 100%; z-index: 1; background: #222; }

    /* HUD (Interfaccia) */
    #hud-top { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; justify-content: space-between; pointer-events: none; }
    .hud-box { background: rgba(0, 20, 0, 0.9); border: 1px solid #0f0; padding: 5px 10px; color: #0f0; font-weight: bold; font-size: 12px; text-shadow: 0 0 5px #0f0; }
    
    /* PULSANTI STATO */
    #hud-status { position: absolute; top: 50px; left: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 5px; }
    .btn-status { background: rgba(0,0,0,0.8); border: 1px solid #555; color: #fff; padding: 8px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; text-align: left; transition: 0.2s; }
    .btn-status:active { transform: scale(0.95); }

    #hud-bottom { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 20px; }
    .action-btn { background: rgba(0,0,0,0.8); border: 2px solid #fff; color: #fff; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; backdrop-filter: blur(4px); box-shadow: 0 0 10px #000; }
    .action-btn:active { background: #fff; color: #000; }

    /* STILE MARKER MAPPA */
    .teammate-label { background: transparent; font-weight: bold; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; font-size: 12px; margin-top: -38px; text-align: center; width: 100px; margin-left: -42px; }
    .exfil-icon { text-align: center; font-size: 20px; text-shadow: 0 0 5px #0f0; }
</style>
</head>
<body>

<div id="login-screen">
    <h1>DMZ: DEPLOY</h1>
    <input type="text" id="p-name" class="input-box" placeholder="NOME OPERATORE">
    <select id="p-team" class="input-box">
        <option value="ALPHA">SQUADRA ALPHA</option>
        <option value="BRAVO">SQUADRA BRAVO</option>
        <option value="CHARLIE">SQUADRA CHARLIE</option>
        <option value="DELTA">SQUADRA DELTA</option>
    </select>
    <button class="btn-deploy" onclick="deploy()">DISPIEGAMENTO</button>
</div>

<div id="map"></div>

<div id="hud-top" style="display:none;">
    <div class="hud-box" id="obj-status">OBIETTIVO: ESTRAZIONE</div>
    <div class="hud-box" id="gps-status">GPS: ATTESA...</div>
</div>

<div id="hud-status" style="display:none;">
    <button class="btn-status" style="border-color:#0f0; color:#0f0;" onclick="setStatus('active', this)">üü¢ IN COMBATTIMENTO</button>
    <button class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('down', this)">üü† DA RIANIMARE</button>
    <button class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('dead', this)">üíÄ ELIMINATO</button>
</div>

<div id="hud-bottom" style="display:none;">
    <div class="action-btn" onclick="centerMap()">üìç</div> 
    <div class="action-btn" onclick="pingLocation()">‚ö†Ô∏è</div> 
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, update, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // -----------------------------------------------------------
    // 1. CONFIGURAZIONE FIREBASE
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCggNlC5bOdGVBzUsfX8wO4ygkNzNcFFm0",
        authDomain: "softair-dmz.firebaseapp.com",
        databaseURL: "https://softair-dmz-default-rtdb.firebaseio.com",
        projectId: "softair-dmz",
        storageBucket: "softair-dmz.firebasestorage.app",
        messagingSenderId: "426944578042",
        appId: "1:426944578042:web:c11e7eddd49bbd3bc76443",
        measurementId: "G-8N023X8HSR"
    };
    
    // -----------------------------------------------------------
    // 2. CONFIGURAZIONE CAMPO DA GIOCO
    // -----------------------------------------------------------
    
    const fieldCenter = [45.679141, 9.896634]; 

    const playAreaCoords = [
        [45.679223271161206, 9.892754719006636],
        [45.679053080947185, 9.894369628150011],
        [45.679488010465164, 9.894333540794852],
        [45.67994184635777, 9.897482162532492],
        [45.67979056813591, 9.89984588429542],
        [45.68035785935887, 9.902110365831659],
        [45.67821215309606, 9.903234794745936],
        [45.67863434946003, 9.896859606506366]
    ];

    const exfilPoints = [
        { lat: 45.680000, lng: 9.896634, label: "EXFIL A" },
        { lat: 45.678000, lng: 9.896634, label: "EXFIL B" } 
    ];

    // -----------------------------------------------------------
    // FINE CONFIGURAZIONE
    // -----------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId = "OP_" + Math.floor(Math.random() * 99999);
    let myName = "";
    let myTeam = "";
    let myStatus = "active"; // Stato iniziale
    let uavActive = false;   // Stato UAV
    let map;
    let myMarker = null;
    let markers = {}; 

    // WAKE LOCK (Schermo Sempre Acceso)
    let wakeLock = null;
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock();
    });

    // AVVIO GIOCO
    window.deploy = function() {
        let n = document.getElementById('p-name').value.trim().toUpperCase();
        if(!n) { alert("Inserisci nome operatore!"); return; }
        
        myName = n;
        myTeam = document.getElementById('p-team').value;
        
        // UI Switch
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('hud-top').style.display = 'flex';
        document.getElementById('hud-status').style.display = 'flex'; // Mostra menu stato
        document.getElementById('hud-bottom').style.display = 'flex';
        
        requestWakeLock();
        try { document.documentElement.requestFullscreen(); } catch(e){}

        initMap();
        startGPS();
        setupNetworking();
    };

    // CAMBIO STATO
    window.setStatus = function(newStatus, btnElement) {
        myStatus = newStatus;
        update(ref(db, 'dmz_players/' + myId), { status: myStatus });

        // Aggiorna grafica bottoni
        let buttons = document.querySelectorAll('.btn-status');
        buttons.forEach(btn => {
            btn.style.borderColor = "#555";
            btn.style.color = "#fff";
        });
        
        if(newStatus === 'active') { btnElement.style.borderColor = "#0f0"; btnElement.style.color = "#0f0"; }
        if(newStatus === 'down') { btnElement.style.borderColor = "#ffa500"; btnElement.style.color = "#ffa500"; }
        if(newStatus === 'dead') { btnElement.style.borderColor = "#aaa"; btnElement.style.color = "#aaa"; }
    };

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView(fieldCenter, 17);
        
        // Mappa Ibrida (Google Maps Satellite + Strade)
        L.tileLayer('http://mt0.google.com/vt/lyrs=y&hl=it&x={x}&y={y}&z={z}', {
            attribution: '¬© Google',
            maxZoom: 20
        }).addTo(map);

        L.polygon(playAreaCoords, { color: 'red', fill: false, weight: 3, dashArray: '10, 10' }).addTo(map);

        exfilPoints.forEach(ex => {
            let icon = L.divIcon({
                className: 'exfil-icon',
                html: `<div style="background:#0f0; color:#000; font-weight:900; padding:4px 8px; border-radius:4px; border:2px solid #fff; font-family:sans-serif;">üöÅ ${ex.label}</div>`,
                iconSize: [80, 30]
            });
            L.marker([ex.lat, ex.lng], {icon: icon}).addTo(map);
        });
    }

    function startGPS() {
        if (!navigator.geolocation) { 
            document.getElementById('gps-status').innerText = "GPS: ERROR";
            return; 
        }

        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const acc = Math.round(pos.coords.accuracy);

                document.getElementById('gps-status').innerText = `GPS: ¬±${acc}m`;

                update(ref(db, 'dmz_players/' + myId), {
                    name: myName,
                    team: myTeam,
                    lat: lat,
                    lng: lng,
                    status: myStatus, // Invia stato
                    lastUpdate: Date.now()
                });

                updateMyMarker(lat, lng);
            },
            (err) => {
                console.error(err);
                document.getElementById('gps-status').innerText = "GPS: NO SEG";
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
    }

    function updateMyMarker(lat, lng) {
        if (!myMarker) {
            let myIcon = L.divIcon({
                className: 'my-icon',
                html: `<div style="width:20px; height:20px; background:cyan; border:3px solid white; border-radius:50%; box-shadow:0 0 15px cyan;"></div>`,
                iconSize: [20, 20]
            });
            myMarker = L.marker([lat, lng], {icon: myIcon}).addTo(map);
            map.setView([lat, lng]); 
        } else {
            myMarker.setLatLng([lat, lng]);
        }
    }

    function setupNetworking() {
        // Ascolta stato UAV globale
        onValue(ref(db, 'dmz_settings/uav_active'), (snapshot) => {
            uavActive = snapshot.val() || false;
            if(uavActive) {
                document.getElementById('obj-status').innerText = "‚ö†Ô∏è UAV ATTIVO: NEMICI VISIBILI";
                document.getElementById('obj-status').style.color = "#f00";
            } else {
                document.getElementById('obj-status').innerText = "OBIETTIVO: ESTRAZIONE";
                document.getElementById('obj-status').style.color = "#0f0";
            }
        });

        // Ascolta altri giocatori
        onValue(ref(db, 'dmz_players'), (snapshot) => {
            const players = snapshot.val() || {};
            
            // FASE A: Pulisci marker vecchi o non visibili
            Object.keys(markers).forEach(key => {
                if (!players[key] || (players[key].team !== myTeam && !uavActive)) {
                    map.removeLayer(markers[key]);
                    delete markers[key];
                }
            });

            // FASE B: Disegna e aggiorna
            Object.keys(players).forEach(key => {
                if (key === myId) return; 

                const p = players[key];
                let isVisible = false;
                let dotColor = "#0f0"; // default alleato
                let iconSymbol = "";

                // Regole Visibilit√† e Fazione
                if (p.team === myTeam) {
                    isVisible = true;
                } else if (uavActive) {
                    isVisible = true;
                    dotColor = "#f00"; // Nemico UAV
                }

                if (isVisible) {
                    // Sovrascrivi se ferito/eliminato
                    if (p.status === "down") {
                        dotColor = "#ffa500"; 
                        iconSymbol = "üè•";
                    } else if (p.status === "dead") {
                        dotColor = "#555555"; 
                        iconSymbol = "üíÄ";
                    }

                    let iconHtml = `
                        <div style="width:20px; height:20px; background:${dotColor}; border:2px solid #000; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:12px;">${iconSymbol}</div>
                        <div class="teammate-label" style="color:${dotColor};">${p.name}</div>
                    `;

                    let pIcon = L.divIcon({ className: 'custom-icon', html: iconHtml, iconSize: [20, 20] });

                    if (!markers[key]) {
                        markers[key] = L.marker([p.lat, p.lng], {icon: pIcon}).addTo(map);
                    } else {
                        markers[key].setIcon(pIcon);
                        markers[key].setLatLng([p.lat, p.lng]);
                    }
                }
            });
        });

        onDisconnect(ref(db, 'dmz_players/' + myId)).remove();
    }

    window.centerMap = function() {
        if(myMarker) map.setView(myMarker.getLatLng(), 18);
    };
    
    window.pingLocation = function() {
        alert("Ping Tattico: In arrivo nelle prossime versioni!");
    };

</script>
</body>
</html>
