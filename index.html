<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>DMZ: TACTICAL MAP v21 - KILLSTREAKS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* STILE MILITARE/DMZ */
    body { margin: 0; padding: 0; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: #0f0; }
    
    /* SCHERMATE (LOGIN / MASTER) */
    .full-screen-ui { position: absolute; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    h1 { color: #fff; text-shadow: 0 0 10px #0f0; font-size: 30px; letter-spacing: 2px; margin-bottom: 5px; text-align: center; }
    .version-tag { color: #555; font-size: 12px; margin-bottom: 20px; font-weight: bold; }
    
    .status-label { font-size: 18px; font-weight: bold; margin-bottom: 20px; padding: 10px; border: 2px dashed #f00; color: #f00; text-align: center; width: 80%; max-width: 300px; }
    .status-label.running { border-color: #0f0; color: #0f0; }

    .input-box { background: #111; border: 1px solid #333; color: #0f0; padding: 12px; margin: 8px; width: 80%; max-width: 300px; text-align: center; font-size: 16px; font-weight: bold; text-transform: uppercase; }
    .input-box::placeholder { color: #040; }
    
    .btn-deploy { background: #004400; color: #fff; border: 2px solid #0f0; padding: 15px 40px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 0 15px #0f0; transition: 0.2s; width: 80%; max-width: 300px; }
    .btn-deploy:active { background: #0f0; color: #000; }

    .btn-master { background: #222; border: 1px solid #555; color: #aaa; padding: 10px; margin-top: 30px; font-size: 12px; cursor: pointer; width: 60%; max-width: 200px; }

    /* TOGGLE SWITCH E IMPOSTAZIONI */
    .toggle-row { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 10px; border: 1px solid #333; margin-top: 15px; width: 80%; max-width: 300px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; border: 2px solid #555; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #0f0; border-color: #0f0; }
    input:checked + .slider:before { transform: translateX(24px); }
    
    .cfg-box { background: #111; border: 1px solid #444; width: 80%; max-width: 300px; padding: 10px; display: none; flex-direction: column; gap: 10px; border-top: none; }
    .cfg-label { color: #aaa; font-size: 10px; text-align: left; }
    .cfg-checkbox-list label { color: #ddd; font-size: 12px; display: flex; align-items: center; gap: 8px; margin-bottom: 5px; cursor: pointer; }
    .cfg-checkbox-list input { transform: scale(1.2); }

    /* MAPPA E MIRINO CENTRALE */
    #map { height: 100vh; width: 100%; z-index: 1; background: #222; }
    #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0, 255, 0, 0.5); font-size: 30px; font-weight: bold; z-index: 1000; pointer-events: none; text-shadow: 0 0 5px #000; display: none; }

    /* EFFETTI A SCHERMO (GAS, EMP, CUAV) */
    #gas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 255, 0.15); z-index: 999; display: none; pointer-events: none; box-shadow: inset 0 0 80px rgba(255,0,255,0.8); }
    #cuav-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 50, 0, 0.4); backdrop-filter: blur(10px) grayscale(80%); z-index: 999; display: none; pointer-events: none; }
    #emp-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; color: #f00; font-family: monospace; font-size: 24px; font-weight: bold; text-align: center; text-shadow: 0 0 15px #f00; }

    /* HUD (Interfaccia) */
    #hud-top { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; justify-content: space-between; pointer-events: none; gap: 5px; }
    .hud-box { background: rgba(0, 20, 0, 0.9); border: 1px solid #0f0; padding: 5px 10px; color: #0f0; font-weight: bold; font-size: 12px; text-shadow: 0 0 5px #0f0; transition: 0.3s; display:flex; align-items:center; }
    .hud-economy { background: rgba(0, 40, 0, 0.9); color: #8f8; border-color: #0a0; pointer-events: auto; cursor: pointer; }

    /* PULSANTI STATO E HUD INFERIORE */
    #hud-status { position: absolute; top: 50px; left: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 5px; }
    .btn-status { background: rgba(0,0,0,0.8); border: 1px solid #555; color: #fff; padding: 8px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; text-align: left; transition: 0.2s; }
    .btn-status:active { transform: scale(0.95); }

    #hud-bottom { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 15px; }
    .action-btn { background: rgba(0,0,0,0.8); border: 2px solid #fff; color: #fff; width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 22px; cursor: pointer; backdrop-filter: blur(4px); box-shadow: 0 0 10px #000; transition: 0.2s; }
    .action-btn:active { background: #fff; color: #000; transform: scale(0.9); }
    .action-btn.btn-scanner { border-color: #0ff; color: #0ff; box-shadow: 0 0 15px #0ff; }

    /* MODALS: SCANNER, SHOP, BACKPACK, LOCKER */
    .game-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 20, 0, 0.95); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; border: 2px solid #0f0; }
    .modal-title { color: #0ff; font-size: 24px; font-weight: bold; margin-bottom: 10px; text-shadow: 0 0 10px #0ff; }
    .modal-desc { color: #0f0; font-size: 12px; margin-bottom: 20px; text-align: center; width: 80%; }
    .btn-close-modal { background: #400; color: #fff; border: 2px solid #f00; padding: 10px 20px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }

    #qr-reader { width: 100%; max-width: 350px; border: 2px solid #0ff; margin-bottom: 15px; background: #111; }

    .shop-item { display:flex; justify-content:space-between; align-items:center; background:#111; border:1px solid #0aa; padding:10px; margin-bottom:8px; width:90%; max-width:350px; color:#fff; font-size:14px; }
    .shop-btn { background:#050; border:1px solid #0f0; color:#0f0; padding:5px 10px; cursor:pointer; font-weight:bold; }
    
    .bp-item { display:flex; flex-direction:column; background:#111; border:1px dashed #8f8; padding:10px; margin-bottom:8px; width:90%; max-width:350px; color:#fff; font-size:14px; }
    
    .locker-panel { flex: 1; border: 2px solid #0aa; background: #0a0a0a; display: flex; flex-direction: column; overflow-y: auto; padding: 5px; height: 300px; }
    .locker-panel h3 { margin: 0 0 10px 0; color: #0aa; font-size: 14px; text-align: center; border-bottom: 1px solid #0aa; padding-bottom: 5px; }
    .locker-item { background: #1a1a1a; border: 1px solid #333; padding: 8px; margin-bottom: 5px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; color: #ddd; }
    .locker-btn { background: #055; border: 1px solid #0ff; color: #0ff; padding: 4px 8px; cursor: pointer; font-size: 10px; font-weight: bold; }

    /* STILE MARKER E PING */
    .teammate-label { background: transparent; font-weight: bold; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; font-size: 12px; margin-top: -38px; text-align: center; width: 100px; margin-left: -42px; }
    .drop-icon { font-size: 30px; text-shadow: 0 0 10px #ff0; cursor: pointer; text-align:center; }
    .exfil-icon { text-align: center; font-size: 20px; text-shadow: 0 0 5px #0f0; }
    .ping-icon { background: rgba(255, 0, 0, 0.8); border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; box-shadow: 0 0 15px #f00; animation: ping-pulse 1s infinite; }
    @keyframes ping-pulse { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }

    /* TARGETING ATTACCO AEREO */
    #targeting-overlay { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(255,0,0,0.8); color: white; padding: 10px 20px; border: 2px solid #fff; font-weight: bold; z-index: 2000; display: none; text-align: center; pointer-events: none; border-radius: 5px; box-shadow: 0 0 20px red; }
</style>
</head>
<body>

<div id="login-screen" class="full-screen-ui">
    <h1>DMZ: DEPLOY</h1>
    <div class="version-tag">SYSTEM v21 - KILLSTREAKS</div>
    
    <div id="status-label" class="status-label">CONNESSIONE...</div>

    <input type="text" id="p-name" class="input-box" placeholder="NOME OPERATORE">
    
    <select id="p-team" class="input-box">
        <option value="ALPHA">SQUADRA ALPHA</option>
        <option value="BRAVO">SQUADRA BRAVO</option>
        <option value="CHARLIE">SQUADRA CHARLIE</option>
        <option value="DELTA">SQUADRA DELTA</option>
    </select>

    <button id="btn-deploy" class="btn-deploy" onclick="deploy()" style="display:none;">DISPIEGAMENTO</button>
    <button class="btn-master" onclick="openMasterPanel()">‚öôÔ∏è PANNELLO MASTER</button>
</div>

<div id="master-screen" class="full-screen-ui" style="display:none; z-index: 2500; overflow-y: auto; padding: 20px 0; justify-content: flex-start;">
    <h1 style="color: #ff0; text-shadow: 0 0 10px #ff0; margin-top:20px;">SISTEMA MASTER</h1>
    <div class="version-tag" style="color: #ff0;">v21</div>
    
    <div class="cfg-label" style="width:80%; max-width:300px; margin-top:10px;">CAMPO OPERATIVO:</div>
    <select id="m-field" class="input-box" style="border-color: #ff0; color: #ff0;">
        <option value="campo1">CAMPO 1: DMZ ORIGINALE</option>
        <option value="campo2">CAMPO 2: ZONA URBANA</option>
        <option value="campo5">CAMPO 5: TEST LOCALE</option>
    </select>

    <div class="toggle-row">
        <span style="color:#f0f; font-weight:bold;">ZONA GAS ‚ò¢Ô∏è</span>
        <label class="switch"><input type="checkbox" id="cfg-gas-toggle" onchange="toggleGasMenu()"><span class="slider"></span></label>
    </div>
    <div id="gas-settings" class="cfg-box">
        <div class="toggle-row" style="margin-top:0; border:none; padding:0;"><span style="color:#f0f; font-size:12px;">GAS LETALE</span><label class="switch"><input type="checkbox" id="cfg-gas-lethal" checked></label></div>
        <div class="cfg-label">TEMPO SOPRAVVIVENZA SENZA MASCHERA (SEC):</div>
        <input type="number" id="cfg-gas-time" class="input-box" style="width:100%; margin:0; padding:8px;" value="30">
        <div class="toggle-row" style="margin-top:10px; border:none; padding:0;"><span style="color:#f0f; font-size:12px;">NEMICI VISIBILI NEL GAS</span><label class="switch"><input type="checkbox" id="cfg-gas-vis" checked></label></div>
        <div class="cfg-label" style="margin-top:10px;">NUMERO RESTRINGIMENTI AREA (STEP):</div>
        <input type="number" id="cfg-gas-steps" class="input-box" style="width:100%; margin:0; padding:8px;" value="3">
        <div class="cfg-label">INTERVALLO TRA STEP (MINUTI):</div>
        <input type="number" id="cfg-gas-interval" class="input-box" style="width:100%; margin:0; padding:8px;" value="10">
    </div>

    <div class="toggle-row">
        <span style="color:#8f8; font-weight:bold;">SISTEMA ECONOMICO üíµ</span>
        <label class="switch"><input type="checkbox" id="cfg-eco-toggle" checked><span class="slider"></span></label>
    </div>

    <div class="toggle-row">
        <span style="color:#ffd700; font-weight:bold;">SISTEMA CHIAVI üîë</span>
        <label class="switch"><input type="checkbox" id="cfg-keys-toggle" checked><span class="slider"></span></label>
    </div>

    <div class="toggle-row">
        <span style="color:#0aa; font-weight:bold;">NEGOZI E KILLSTREAKS üõí</span>
        <label class="switch"><input type="checkbox" id="cfg-shops-toggle" checked onchange="toggleShopMenu()"><span class="slider"></span></label>
    </div>
    <div id="shop-settings" class="cfg-box" style="display:flex;">
        <div class="cfg-label">LISTINO PREZZI NEGOZIO:</div>
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="text" id="shop-name" class="input-box" style="width:60%; margin:0; padding:5px; font-size:10px;" placeholder="OGGETTO">
            <input type="number" id="shop-price" class="input-box" style="width:40%; margin:0; padding:5px; font-size:10px; border-color:#8f8; color:#8f8;" placeholder="PREZZO $">
        </div>
        <button class="btn-deploy" style="background:#333; border-color:#aaa; font-size:12px; padding:8px; margin:0;" onclick="addShopItem()">+ AGGIUNGI IN VENDITA</button>
        <div id="shop-list" style="margin-top:10px; border-top:1px solid #444; padding-top:10px; max-height:150px; overflow-y:auto; font-family:'Courier New', monospace;"></div>
    </div>

    <div class="toggle-row">
        <span style="color:#e6b800; font-weight:bold;">ARMADIETTI E LOOT (A) üì¶</span>
        <label class="switch"><input type="checkbox" id="cfg-lockers-toggle" checked onchange="toggleLockerMenu()"><span class="slider"></span></label>
    </div>
    <div id="locker-settings" class="cfg-box" style="display:flex;">
        <div class="cfg-label" style="color:#8f8; font-weight:bold; margin-top:10px;">PROBABILIT√Ä DENARO (Somma = 100%):</div>
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="number" id="money-amount" class="input-box" style="width:50%; margin:0; padding:5px; font-size:10px; color:#8f8; border-color:#8f8;" placeholder="IMPORTO $">
            <input type="number" id="money-chance" class="input-box" style="width:50%; margin:0; padding:5px; font-size:10px;" placeholder="% CHANCE">
        </div>
        <button class="btn-deploy" style="background:#030; border-color:#0f0; font-size:12px; padding:8px; margin:0;" onclick="addMoneyItem()">+ AGGIUNGI PACCHETTO DENARO</button>
        <div id="money-list" style="margin-top:10px; border-top:1px dashed #8f8; padding-top:10px; max-height:100px; overflow-y:auto;"></div>

        <div class="cfg-label" style="color:#e6b800; font-weight:bold; margin-top:20px;">PROBABILIT√Ä OGGETTI (Somma = 100%):</div>
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="text" id="loot-name" class="input-box" style="width:40%; margin:0; padding:5px; font-size:10px;" placeholder="NOME OGGETTO">
            <input type="number" id="loot-chance" class="input-box" style="width:25%; margin:0; padding:5px; font-size:10px;" placeholder="%">
            <input type="number" id="loot-value" class="input-box" style="width:35%; margin:0; padding:5px; font-size:10px; border-color:#8f8; color:#8f8;" placeholder="VALORE $">
        </div>
        <button class="btn-deploy" style="background:#330; border-color:#ff0; font-size:12px; padding:8px; margin:0;" onclick="addLootItem()">+ AGGIUNGI OGGETTO</button>
        <div id="loot-list" style="margin-top:10px; border-top:1px dashed #ff0; padding-top:10px; max-height:150px; overflow-y:auto;"></div>
    </div>

    <div class="toggle-row">
        <span style="color:#0ff; font-weight:bold;">ESFILTRAZIONE üöÅ</span>
        <label class="switch"><input type="checkbox" id="cfg-exfil-toggle" checked onchange="toggleExfilMenu()"><span class="slider"></span></label>
    </div>
    <div id="exfil-settings" class="cfg-box" style="display:flex;">
        <div class="cfg-label">NUMERO PUNTI (Segnali C):</div>
        <input type="number" id="cfg-exfil-num" class="input-box" style="width:100%; margin:0; padding:8px;" value="2">
        <div class="cfg-label">TEMPO DI ATTESA (MINUTI):</div>
        <input type="number" id="cfg-exfil-wait" class="input-box" style="width:100%; margin:0; padding:8px;" value="3">
    </div>

    <div class="toggle-row">
        <span style="color:#e6e6fa; font-weight:bold;">CONTRATTI BASI (B) üìú</span>
        <label class="switch"><input type="checkbox" id="cfg-contracts-toggle" checked onchange="toggleContractsMenu()"><span class="slider"></span></label>
    </div>
    <div id="contracts-settings" class="cfg-box cfg-checkbox-list" style="display:flex;">
        <label><input type="checkbox" class="contract-cb" value="INTEL" checked> RECUPERO DATI SEGRETI</label>
        <label><input type="checkbox" class="contract-cb" value="HVT" checked> ELIMINAZIONE BERSAGLIO (HVT)</label>
        <label><input type="checkbox" class="contract-cb" value="DESTROY" checked> DISTRUZIONE SCORTE</label>
    </div>

    <div class="toggle-row">
        <span style="color:#ffa500; font-weight:bold;">SISTEMA MEDICO üè•</span>
        <label class="switch"><input type="checkbox" id="cfg-medic-toggle" checked onchange="toggleMedicMenu()"><span class="slider"></span></label>
    </div>
    <div id="medic-settings" class="cfg-box" style="display:flex;">
        <div class="cfg-label">TEMPO DISSANGUAMENTO (SECONDI):</div>
        <input type="number" id="cfg-medic-bleedout" class="input-box" style="width:100%; margin:0; padding:8px; border-color:#ffa500; color:#ffa500;" value="60">
    </div>

    <button class="btn-deploy" style="background:#004400; border-color:#0f0; margin-top:40px;" onclick="masterStartGame()">üöÄ AVVIA PARTITA</button>
    <button class="btn-deploy" style="background:#400; border-color:#f00; box-shadow: 0 0 15px #f00;" onclick="masterStopGame()">‚èπ TERMINA PARTITA</button>
    <button class="btn-master" style="margin-bottom: 50px;" onclick="closeMasterPanel()">TORNA AL LOGIN</button>
</div>

<div id="scanner-modal" class="game-modal">
    <div class="modal-title">SCANSIONE OTTICA</div>
    <div class="modal-desc">Inquadra il QR Code oppure inserisci manualmente.</div>
    <div id="qr-reader"></div>
    <div style="display:flex; width: 90%; max-width: 350px; gap: 5px; margin-top: 10px;">
        <input type="text" id="manual-code-input" class="input-box" placeholder="ES: A12" style="width:70%; font-size:18px; border-color:#0ff; color:#0ff; text-transform:uppercase; margin:0;">
        <button class="btn-deploy" style="width:30%; background:#004444; border-color:#0ff; box-shadow: 0 0 10px #0ff; margin:0; padding:10px;" onclick="processScannedCode()">INVIA</button>
    </div>
    <button class="btn-close-modal" onclick="closeScanner()">ANNULLA</button>
</div>

<div id="locker-modal" class="game-modal">
    <div class="modal-title" id="locker-title" style="color:#e6b800; text-shadow:0 0 10px #e6b800;">ARMADIETTO</div>
    <div style="display:flex; width:95%; max-width: 400px; gap:10px; height: 60%;">
        <div class="locker-panel"><h3 style="color:#e6b800; border-color:#e6b800;">CASSA</h3><div id="locker-money-box" style="margin-bottom:10px; padding:5px; background:#020; border:1px solid #0f0;"></div><div id="locker-items-box"></div></div>
        <div class="locker-panel"><h3 style="color:#8f8; border-color:#8f8;">ZAINO</h3><div id="locker-backpack-box"></div></div>
    </div>
    <button class="btn-close-modal" style="border-color:#e6b800;" onclick="closeLocker()">CHIUDI SPORTELLO</button>
</div>

<div id="shop-modal" class="game-modal">
    <div class="modal-title" style="color:#0aa; text-shadow:0 0 10px #0aa;">MERCATO NERO</div>
    <div id="shop-items-container" style="width:100%; display:flex; flex-direction:column; align-items:center; overflow-y:auto; max-height:50%;"></div>
    <button class="btn-close-modal" style="border-color:#0aa;" onclick="closeShop()">ESCI</button>
</div>

<div id="backpack-modal" class="game-modal">
    <div class="modal-title" style="color:#8f8; text-shadow:0 0 10px #8f8;">IL TUO ZAINO</div>
    <div class="modal-desc" id="bp-desc" style="color:#8f8;">Usa o getta gli oggetti (Capacit√†: 5 slot)</div>
    <div id="bp-items-container" style="width:100%; display:flex; flex-direction:column; align-items:center; overflow-y:auto; max-height:50%;"></div>
    <button class="btn-close-modal" style="border-color:#8f8;" onclick="closeBackpack()">CHIUDI</button>
</div>

<div id="emp-overlay">‚ö†Ô∏è ERRORE CRITICO ‚ö†Ô∏è<br><br>IMPULSO ELETROMAGNETICO<br>RILEVATO</div>
<div id="map"></div>
<div id="gas-overlay"></div>
<div id="cuav-overlay"></div>
<div id="crosshair">‚úõ</div>
<div id="targeting-overlay">‚¨á CLICCA SULLA MAPPA PER LANCIARE L'ATTACCO AEREO ‚¨á</div>

<div id="hud-top" style="display:none;">
    <div class="hud-box" id="obj-status" style="max-width:50%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">OBIETTIVO: SOPRAVVIVENZA</div>
    <div id="hud-economy-box" class="hud-box hud-economy" style="display:none;" onclick="openBackpack()">
        <span id="txt-cash">üíµ $0</span>&nbsp;|&nbsp;<span id="txt-bp">üéí 0/5</span>
    </div>
</div>

<div id="hud-status" style="display:none;">
    <button id="btn-status-active" class="btn-status" style="border-color:#0f0; color:#0f0;" onclick="setStatus('active', this)">üü¢ IN COMBATTIMENTO</button>
    <button id="btn-status-down" class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('down', this)">üü† DA RIANIMARE</button>
    <button id="btn-status-dead" class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('dead', this)">üíÄ ELIMINATO</button>
</div>

<div id="hud-bottom" style="display:none;">
    <div class="action-btn" onclick="centerMap()">üìç</div> 
    <div class="action-btn btn-scanner" onclick="openScanner()">üì∑</div> 
    <div class="action-btn" onclick="pingLocation()">‚ö†Ô∏è</div> 
</div>

<div id="out-of-bounds-warning">
    <div class="warning-text">‚ö†Ô∏è ATTENZIONE ‚ö†Ô∏è<br>SEI FUORI DALLA ZONA OPERATIVA</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, update, set, onDisconnect, onValue, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCggNlC5bOdGVBzUsfX8wO4ygkNzNcFFm0", authDomain: "softair-dmz.firebaseapp.com", databaseURL: "https://softair-dmz-default-rtdb.firebaseio.com", projectId: "softair-dmz" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const masterBasesDB = [
        { id: "B1", lat: 45.6792, lng: 9.8950, name: "COMANDO NORD" },
        { id: "B2", lat: 45.6788, lng: 9.8970, name: "DEPOSITO" },
        { id: "B3", lat: 45.0005, lng: 9.0000, name: "URBAN CENTRALE" }
    ];

    const fieldsDB = {
        "campo1": { center: [45.679141, 9.896634], boundaries: [[45.6792, 9.8927], [45.6790, 9.8943], [45.6799, 9.8974], [45.6782, 9.9032]], exfils: [ { lat: 45.6800, lng: 9.8966, label: "EXFIL C1" } ] },
        "campo5": { center: [45.699417, 9.827667], boundaries: [[45.7014, 9.8256], [45.7014, 9.8296], [45.6974, 9.8296], [45.6974, 9.8256]], exfils: [ { lat: 45.6998, lng: 9.8276, label: "EXFIL C1" } ] }
    };
    
    let activeFieldCenter = [], activePlayAreaCoords = [], activeExfilPoints = [], activeBases = [];

    let myId = "OP_" + Math.floor(Math.random() * 99999);
    let myName = "", myTeam = "", myStatus = "active", myCash = 0, myBackpack = [];
    let map, myMarker = null, markers = {}; 
    let isDeployed = false, bleedoutTimer = null, localUAVActive = false, isTargetingAirstrike = false;
    
    // LISTE DI DEFAULT CON KILLSTREAKS
    let masterMoneyPool = [{ amount: 0, chance: 30, enabled: true }, { amount: 500, chance: 40, enabled: true }, { amount: 2500, chance: 30, enabled: true }];
    let masterLootPool = [
        { name: "VUOTO", chance: 15, value: 0, enabled: true },
        { name: "CHIAVE UNIVERSALE", chance: 5, value: 5000, enabled: true },
        { name: "MASCHERA GAS SEMPLICE", chance: 15, value: 500, enabled: true },
        { name: "Hard Disk Segreto", chance: 15, value: 2500, enabled: true },
        { name: "Benda Medica", chance: 20, value: 0, enabled: true },
        { name: "ATTACCO AEREO", chance: 10, value: 4000, enabled: true },
        { name: "LANCIO EQUIPAGGIAMENTO", chance: 10, value: 5000, enabled: true },
        { name: "UAV DI DISTURBO", chance: 10, value: 2500, enabled: true }
    ];
    let masterShopPool = [
        { name: "CHIAVE UNIVERSALE", price: 10000, enabled: true },
        { name: "MASCHERA GAS COMPLETA", price: 3000, enabled: true },
        { name: "Terminale UAV", price: 4000, enabled: true },
        { name: "Kit Medico", price: 1500, enabled: true },
        { name: "ATTACCO AEREO", price: 8000, enabled: true },
        { name: "IMPULSO EMP", price: 12000, enabled: true },
        { name: "LANCIO EQUIPAGGIAMENTO", price: 10000, enabled: true }
    ];

    let globalSettings = { status: 'lobby' };
    let activeStreaks = {};

    let wakeLock = null;
    async function requestWakeLock() { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
    function enableImmersiveMode() { if (!document.fullscreenElement) try { document.documentElement.requestFullscreen().catch(e => {}); } catch(e) {} if (wakeLock === null) requestWakeLock(); }
    document.addEventListener('click', enableImmersiveMode); document.addEventListener('touchstart', enableImmersiveMode, {passive: true});

    // -----------------------------------------------------------
    // UI PANNELLO MASTER
    // -----------------------------------------------------------
    window.toggleGasMenu = function() { document.getElementById('gas-settings').style.display = document.getElementById('cfg-gas-toggle').checked ? 'block' : 'none'; };
    window.toggleExfilMenu = function() { document.getElementById('exfil-settings').style.display = document.getElementById('cfg-exfil-toggle').checked ? 'flex' : 'none'; };
    window.toggleLockerMenu = function() { document.getElementById('locker-settings').style.display = document.getElementById('cfg-lockers-toggle').checked ? 'flex' : 'none'; };
    window.toggleShopMenu = function() { document.getElementById('shop-settings').style.display = document.getElementById('cfg-shops-toggle').checked ? 'flex' : 'none'; };
    window.toggleContractsMenu = function() { document.getElementById('contracts-settings').style.display = document.getElementById('cfg-contracts-toggle').checked ? 'flex' : 'none'; };
    window.toggleMedicMenu = function() { document.getElementById('medic-settings').style.display = document.getElementById('cfg-medic-toggle').checked ? 'flex' : 'none'; };

    window.renderMoneyList = function() {
        const list = document.getElementById('money-list'); list.innerHTML = ""; let t = 0;
        masterMoneyPool.forEach((i, idx) => { if(i.enabled) t += i.chance; let chk = i.enabled ? "checked" : "", op = i.enabled ? "1" : "0.4"; list.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:12px; color:#8f8; margin-bottom:5px; align-items:center; opacity:${op};"><div style="display:flex; align-items:center; gap:8px;"><input type="checkbox" ${chk} onchange="toggleMoneyItem(${idx})" style="transform:scale(1.2);"><span>$${i.amount} (${i.chance}%)</span></div><span style="color:red;cursor:pointer;font-weight:bold;padding:2px 5px;" onclick="removeMoneyItem(${idx})">X</span></div>`; });
    };
    window.toggleMoneyItem = function(idx) { masterMoneyPool[idx].enabled = !masterMoneyPool[idx].enabled; window.renderMoneyList(); };
    window.addMoneyItem = function() { let a=parseInt(document.getElementById('money-amount').value)||0, c=parseInt(document.getElementById('money-chance').value); if(c>0){ masterMoneyPool.push({amount:a, chance:c, enabled: true}); window.renderMoneyList(); } };
    window.removeMoneyItem = function(idx) { masterMoneyPool.splice(idx, 1); window.renderMoneyList(); };

    window.renderLootList = function() {
        const list = document.getElementById('loot-list'); list.innerHTML = ""; let t = 0;
        masterLootPool.forEach((i, idx) => { if(i.enabled) t += i.chance; let valStr = i.value > 0 ? `<span style="color:#8f8;">$${i.value}</span>` : `<span style="color:#aaa;">Consum.</span>`; let chk = i.enabled ? "checked" : "", op = i.enabled ? "1" : "0.4"; list.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:12px; color:#e6b800; margin-bottom:5px; align-items:center; opacity:${op};"><div style="display:flex; align-items:center; gap:8px;"><input type="checkbox" ${chk} onchange="toggleLootItem(${idx})" style="transform:scale(1.2);"><span>- ${i.name} (${i.chance}%) - ${valStr}</span></div><span style="color:red;cursor:pointer;font-weight:bold;padding:2px 5px;" onclick="removeLootItem(${idx})">X</span></div>`; });
    };
    window.toggleLootItem = function(idx) { masterLootPool[idx].enabled = !masterLootPool[idx].enabled; window.renderLootList(); };
    window.addLootItem = function() { let n=document.getElementById('loot-name').value.toUpperCase(), c=parseInt(document.getElementById('loot-chance').value), v=parseInt(document.getElementById('loot-value').value)||0; if(n&&c>0){ masterLootPool.push({name:n, chance:c, value:v, enabled: true}); window.renderLootList(); } };
    window.removeLootItem = function(idx) { masterLootPool.splice(idx, 1); window.renderLootList(); };

    window.renderShopList = function() {
        const list = document.getElementById('shop-list'); list.innerHTML = "";
        masterShopPool.forEach((i, idx) => { let chk = i.enabled ? "checked" : "", op = i.enabled ? "1" : "0.4"; list.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:12px; color:#0aa; margin-bottom:5px; align-items:center; opacity:${op};"><div style="display:flex; align-items:center; gap:8px;"><input type="checkbox" ${chk} onchange="toggleShopItem(${idx})" style="transform:scale(1.2);"><span>- ${i.name} [$${i.price}]</span></div><span style="color:red;cursor:pointer;font-weight:bold;padding:2px 5px;" onclick="removeShopItem(${idx})">X</span></div>`; });
    };
    window.toggleShopItem = function(idx) { masterShopPool[idx].enabled = !masterShopPool[idx].enabled; window.renderShopList(); };
    window.addShopItem = function() { let n=document.getElementById('shop-name').value.toUpperCase(), p=parseInt(document.getElementById('shop-price').value); if(n&&p>0){ masterShopPool.push({name:n, price:p, enabled:true}); window.renderShopList(); } };
    window.removeShopItem = function(idx) { masterShopPool.splice(idx, 1); window.renderShopList(); };

    // -----------------------------------------------------------
    // FIREBASE SYNC & MASTER GAME START
    // -----------------------------------------------------------
    onValue(ref(db, 'dmz_settings'), (snapshot) => {
        let data = snapshot.val(); if(data) globalSettings = data;
        if (globalSettings.status === 'running') {
            document.getElementById('status-label').innerText = "üü¢ PARTITA IN CORSO"; document.getElementById('status-label').className = "status-label running";
            document.getElementById('btn-deploy').style.display = "block";
        } else {
            document.getElementById('status-label').innerText = "üî¥ IN ATTESA DEL MASTER"; document.getElementById('status-label').className = "status-label";
            document.getElementById('btn-deploy').style.display = "none";
            if (isDeployed) { alert("Partita Terminata!"); window.location.reload(); }
        }
        if (isDeployed) { 
            document.getElementById('hud-economy-box').style.display = globalSettings.economy_active ? 'flex' : 'none'; 
            getDatabase()._root && get(ref(db, 'dmz_players')); 
        }
    });

    onValue(ref(db, 'dmz_streaks'), (snap) => {
        activeStreaks = snap.val() || {};
        // Gestisci cerchi Airstrike visivamente
        if(activeStreaks.airstrikes && map) {
            Object.keys(activeStreaks.airstrikes).forEach(k => {
                let s = activeStreaks.airstrikes[k];
                if (Date.now() < s.timestamp + 20000) {
                    if (!window.strikeCircles) window.strikeCircles = {};
                    if (!window.strikeCircles[k]) {
                        window.strikeCircles[k] = L.circle([s.lat, s.lng], {color: 'red', fillColor: '#f00', fillOpacity: 0.4, radius: 40}).addTo(map);
                        // Suono allarme locale
                        try { navigator.vibrate([200,100,200,100,200]); }catch(e){}
                    }
                }
            });
            // Pulizia cerchi vecchi
            if(window.strikeCircles) {
                Object.keys(window.strikeCircles).forEach(k => {
                    if(!activeStreaks.airstrikes[k] || Date.now() > activeStreaks.airstrikes[k].timestamp + 20000) {
                        map.removeLayer(window.strikeCircles[k]); delete window.strikeCircles[k];
                    }
                });
            }
        }
        
        // Ascolto Drops
        if(map) {
            get(ref(db, 'dmz_lockers')).then(snap => {
                let lockers = snap.val() || {};
                if(!window.dropMarkers) window.dropMarkers = {};
                Object.keys(window.dropMarkers).forEach(k => { if(!lockers[k]) { map.removeLayer(window.dropMarkers[k]); delete window.dropMarkers[k]; } });
                Object.keys(lockers).forEach(k => {
                    if(k.startsWith("DROP_") && lockers[k].lat) {
                        if(!window.dropMarkers[k]) {
                            let m = L.marker([lockers[k].lat, lockers[k].lng], {icon: L.divIcon({className: 'drop-icon', html: `üéÅ DROP`})}).addTo(map);
                            m.on('click', () => { if(myStatus === 'active') openLockerUI(k, lockers[k]); });
                            window.dropMarkers[k] = m;
                        }
                    }
                });
            });
        }
    });

    window.openMasterPanel = function() { if(prompt("PIN:")==="0000"){ document.getElementById('master-screen').style.display='flex'; renderMoneyList(); renderLootList(); renderShopList(); }else alert("NO"); };
    window.closeMasterPanel = function() { document.getElementById('master-screen').style.display = 'none'; };

    window.masterStartGame = function() {
        let activeMoney = masterMoneyPool.filter(i => i.enabled); let activeLoot = masterLootPool.filter(i => i.enabled); let activeShop = masterShopPool.filter(i => i.enabled);
        let activeContracts = []; if (document.getElementById('cfg-contracts-toggle').checked) { document.querySelectorAll('.contract-cb:checked').forEach(cb => activeContracts.push(cb.value)); }

        update(ref(db, 'dmz_settings'), {
            status: 'running', activeField: document.getElementById('m-field').value,
            economy_active: document.getElementById('cfg-eco-toggle').checked,
            keys_active: document.getElementById('cfg-keys-toggle').checked,
            shop_config: { enabled: document.getElementById('cfg-shops-toggle').checked, pool: activeShop },
            exfil_config: { enabled: document.getElementById('cfg-exfil-toggle').checked, numPoints: parseInt(document.getElementById('cfg-exfil-num').value)||2 },
            lockers_config: { enabled: document.getElementById('cfg-lockers-toggle').checked, pool: activeLoot, moneyPool: activeMoney },
            contracts_config: { enabled: document.getElementById('cfg-contracts-toggle').checked, pool: activeContracts },
            medic_active: document.getElementById('cfg-medic-toggle').checked,
            bleedout_time: parseInt(document.getElementById('cfg-medic-bleedout').value) || 60,
            gas_config: {
                enabled: document.getElementById('cfg-gas-toggle').checked, lethal: document.getElementById('cfg-gas-lethal').checked,
                survivalTime: parseInt(document.getElementById('cfg-gas-time').value) || 30, visibility: document.getElementById('cfg-gas-vis').checked,
                steps: parseInt(document.getElementById('cfg-gas-steps').value) || 3, interval: parseInt(document.getElementById('cfg-gas-interval').value) || 10, startTime: Date.now()
            }
        });
        set(ref(db, 'dmz_lockers'), null); set(ref(db, 'dmz_streaks'), null);
        alert("PARTITA INIZIATA.");
    };
    window.masterStopGame = function() { if(confirm("Terminare?")) { update(ref(db, 'dmz_settings'), { status: 'lobby' }); set(ref(db, 'dmz_players'), null); } };

    // -----------------------------------------------------------
    // GESTIONE ARMADIETTO E DROP
    // -----------------------------------------------------------
    let currentLockerCode = null; let currentLockerData = null;

    function openLockerUI(code, data) {
        currentLockerCode = code; currentLockerData = data;
        document.getElementById('locker-title').innerText = code.startsWith("DROP_") ? "CASSA EQUIPAGGIAMENTO" : `ARMADIETTO ${code}`;
        renderLockerUI(); document.getElementById('locker-modal').style.display = 'flex';
    }

    function renderLockerUI() {
        let lMoney = document.getElementById('locker-money-box');
        if (currentLockerData.money > 0) { lMoney.innerHTML = `<span style="color:#8f8; font-weight:bold;">üíµ $${currentLockerData.money}</span> <button class="locker-btn" style="float:right;" onclick="takeMoney()">PRELEVA</button>`; } 
        else { lMoney.innerHTML = `<span style="color:#555;">üíµ Nessun contante</span>`; }

        let lItems = document.getElementById('locker-items-box'); lItems.innerHTML = "";
        if (!currentLockerData.items || currentLockerData.items.length === 0) { lItems.innerHTML = "<div style='color:#555; font-size:12px; padding:5px;'>Vuoto.</div>"; } 
        else {
            currentLockerData.items.forEach((it, i) => {
                let v = it.value > 0 ? `$${it.value}` : "Cons."; let u = it.uses !== undefined ? ` [${it.uses}/3 usi]` : "";
                lItems.innerHTML += `<div class="locker-item"><span>${it.name}${u} <span style="color:#aaa;">(${v})</span></span><button class="locker-btn" onclick="takeItem(${i})">PRENDI</button></div>`;
            });
        }

        let bpBox = document.getElementById('locker-backpack-box'); bpBox.innerHTML = "";
        if (myBackpack.length === 0) { bpBox.innerHTML = "<div style='color:#555; font-size:12px; padding:5px;'>Zaino vuoto.</div>"; } 
        else {
            myBackpack.forEach((it, i) => {
                let v = it.value > 0 ? `$${it.value}` : "Cons."; let u = it.uses !== undefined ? ` [${it.uses}/3 usi]` : "";
                bpBox.innerHTML += `<div class="locker-item" style="border-color:#8f8;"><span>${it.name}${u} <span style="color:#aaa;">(${v})</span></span><button class="locker-btn" style="background:#050; border-color:#0f0;" onclick="depositItem(${i})">DEPOSITA</button></div>`;
            });
        }
    }

    window.takeMoney = function() { myCash += currentLockerData.money; currentLockerData.money = 0; updateEconomyHUD(); update(ref(db, `dmz_lockers/${currentLockerCode}`), currentLockerData); renderLockerUI(); };
    window.takeItem = function(idx) { if (myBackpack.length >= 5) return alert("Zaino pieno!"); let it = currentLockerData.items.splice(idx, 1)[0]; myBackpack.push(it); updateEconomyHUD(); update(ref(db, `dmz_lockers/${currentLockerCode}`), currentLockerData); renderLockerUI(); };
    window.depositItem = function(idx) { let it = myBackpack.splice(idx, 1)[0]; if(!currentLockerData.items) currentLockerData.items = []; currentLockerData.items.push(it); updateEconomyHUD(); update(ref(db, `dmz_lockers/${currentLockerCode}`), currentLockerData); renderLockerUI(); };
    window.closeLocker = function() { document.getElementById('locker-modal').style.display = 'none'; currentLockerCode = null; currentLockerData = null; };

    function generateLockerContent() {
        let money = 0, items = [];
        let pMoney = globalSettings.lockers_config.moneyPool; let pItems = globalSettings.lockers_config.pool;
        if (globalSettings.economy_active && pMoney && pMoney.length > 0) { let rM = Math.random() * 100, cM = 0; for(let m of pMoney) { cM += m.chance; if(rM <= cM){ money = m.amount; break; } } }
        if (pItems && pItems.length > 0) {
            let rI = Math.random() * 100, cI = 0;
            for(let i of pItems) { cI += i.chance; if(rI <= cI){ if(i.name !== "VUOTO") { let newItem = { ...i }; if (newItem.name.includes("CHIAVE")) newItem.uses = 3; items.push(newItem); } break; } }
        }
        return { money, items };
    }

    // -----------------------------------------------------------
    // ZAINO, CHIAVI E KILLSTREAKS
    // -----------------------------------------------------------
    window.updateEconomyHUD = function() { document.getElementById('txt-cash').innerText = `üíµ $${myCash}`; document.getElementById('txt-bp').innerText = `üéí ${myBackpack.length}/5`; update(ref(db, 'dmz_players/' + myId), { cash: myCash, backpack: myBackpack }); };
    
    window.openBackpack = function() {
        const cont = document.getElementById('bp-items-container'); cont.innerHTML = "";
        if(myBackpack.length === 0) { cont.innerHTML = "<div style='color:#888; margin-top:20px;'>Lo zaino √® vuoto.</div>"; } else {
            myBackpack.forEach((item, idx) => {
                let btns = `<button class="shop-btn" style="background:#800; border-color:#f00; color:#f00;" onclick="discardItem(${idx})">GETTA</button>`;
                
                // Parsing Oggetti Speciali
                if (item.name.includes("UAV") && !item.name.includes("DISTURBO")) btns = `<button class="shop-btn" style="background:#055; border-color:#0ff; color:#0ff; margin-right:5px;" onclick="useItem(${idx}, 'UAV')">USA</button>` + btns;
                else if (item.name.includes("DISTURBO")) btns = `<button class="shop-btn" style="background:#550; border-color:#ff0; color:#ff0; margin-right:5px;" onclick="useItem(${idx}, 'CUAV')">USA</button>` + btns;
                else if (item.name.includes("AEREO")) btns = `<button class="shop-btn" style="background:#900; border-color:#f00; color:#f00; margin-right:5px;" onclick="useItem(${idx}, 'AIRSTRIKE')">USA</button>` + btns;
                else if (item.name.includes("EMP")) btns = `<button class="shop-btn" style="background:#00f; border-color:#0cf; color:#fff; margin-right:5px;" onclick="useItem(${idx}, 'EMP')">USA</button>` + btns;
                else if (item.name.includes("LANCIO")) btns = `<button class="shop-btn" style="background:#0a0; border-color:#0f0; color:#000; margin-right:5px;" onclick="useItem(${idx}, 'DROP')">USA</button>` + btns;
                else if (item.name.includes("MEDICO")) btns = `<button class="shop-btn" style="background:#050; border-color:#0f0; color:#0f0; margin-right:5px;" onclick="useItem(${idx}, 'MEDIC')">USA</button>` + btns;
                
                let uText = item.uses !== undefined ? ` [Usi: ${item.uses}/3]` : "";
                cont.innerHTML += `<div class="bp-item"><div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;"><span style="font-weight:bold;">${item.name}${uText}</span><span style="color:#aaa;">Val: $${item.value || 0}</span></div><div style="width:100%; display:flex; justify-content:flex-end;">${btns}</div></div>`;
            });
        }
        document.getElementById('backpack-modal').style.display = 'flex';
    };
    window.closeBackpack = function() { document.getElementById('backpack-modal').style.display = 'none'; };

    window.discardItem = function(idx) { if(confirm(`Vuoi abbandonare ${myBackpack[idx].name}? Andr√† perso.`)) { myBackpack.splice(idx, 1); updateEconomyHUD(); openBackpack(); } };
    
    window.useItem = function(idx, type) {
        if (myStatus !== 'active' && type !== 'MEDIC') return alert("Non puoi usare questo oggetto da terra.");
        let item = myBackpack[idx];

        if (type === 'MEDIC') {
            if (myStatus === 'active') return alert("Sei gi√† curato!"); if (myStatus === 'dead') return alert("Sei eliminato.");
            alert(`Usato ${item.name}. Sei tornato in combattimento!`); myBackpack.splice(idx, 1); updateEconomyHUD(); openBackpack(); setStatus('active'); 
        } 
        else if (type === 'UAV') {
            alert(`Radar locale attivato per 30 secondi.`); myBackpack.splice(idx, 1); updateEconomyHUD(); closeBackpack();
            localUAVActive = true; update(ref(db, 'dmz_players/' + myId), { lastUpdate: Date.now() }); 
            setTimeout(() => { localUAVActive = false; alert("Radar esaurito."); update(ref(db, 'dmz_players/' + myId), { lastUpdate: Date.now() }); }, 30000);
        }
        else if (type === 'CUAV') {
            alert(`UAV di Disturbo Lanciato! Elettronica nemica oscurata.`); myBackpack.splice(idx, 1); updateEconomyHUD(); closeBackpack();
            update(ref(db, 'dmz_streaks/cuav'), { active: true, team: myTeam, endTime: Date.now() + 60000 });
        }
        else if (type === 'EMP') {
            alert(`Impulso EMP Inviato! Sistemi nemici distrutti.`); myBackpack.splice(idx, 1); updateEconomyHUD(); closeBackpack();
            update(ref(db, 'dmz_streaks/emp'), { active: true, team: myTeam, endTime: Date.now() + 60000 });
        }
        else if (type === 'DROP') {
            alert(`Lancio Equipaggiamento in arrivo sulle tue coordinate!`); myBackpack.splice(idx, 1); updateEconomyHUD(); closeBackpack();
            let dropId = "DROP_" + Math.floor(Math.random()*9999);
            let dropData = { money: 5000, items: [{name: "CHIAVE UNIVERSALE", value: 5000, uses: 3}, {name: "Hard Disk Segreto", value: 5000}], lat: myMarker.getLatLng().lat, lng: myMarker.getLatLng().lng };
            update(ref(db, `dmz_lockers/${dropId}`), dropData);
        }
        else if (type === 'AIRSTRIKE') {
            closeBackpack(); document.getElementById('targeting-overlay').style.display = 'block'; isTargetingAirstrike = true;
            document.getElementById('map').style.cursor = 'crosshair';
            // Il resto viene gestito al click sulla mappa
            window.airstrikeIdxPending = idx;
        }
    };

    function consumeKey(targetCode) {
        if (!globalSettings.keys_active) return true; 
        let targetKeyName = `CHIAVE ${targetCode}`;
        let specificIdx = myBackpack.findIndex(i => i.name === targetKeyName); let univIdx = myBackpack.findIndex(i => i.name === "CHIAVE UNIVERSALE");
        let idxToUse = specificIdx > -1 ? specificIdx : univIdx;
        
        if (idxToUse > -1) {
            let key = myBackpack[idxToUse]; if (key.uses === undefined) key.uses = 3;
            if (confirm(`Serratura bloccata. Usare ${key.name}?\n(Usi rimanenti: ${key.uses}/3)`)) {
                key.uses -= 1;
                if (key.uses <= 0) { myBackpack.splice(idxToUse, 1); alert(`La porta si √® sbloccata!\nLa ${key.name} si √® rotta ed √® stata gettata.`); } 
                else { alert(`La porta si √® sbloccata!\nUsi rimanenti: ${key.uses}/3.`); }
                updateEconomyHUD(); return true;
            } else return false;
        }
        alert(`ACCESSO NEGATO: Ti serve la CHIAVE ${targetCode} o UNIVERSALE.`); return false;
    }

    // -----------------------------------------------------------
    // SCANNER QR
    // -----------------------------------------------------------
    let html5QrCode = null;
    window.openScanner = function() { 
        if(myStatus !== 'active') return alert("Sei a terra o eliminato!");
        if(document.getElementById('emp-overlay').style.display === 'flex') return alert("SISTEMA BLOCCATO DA EMP.");
        document.getElementById('scanner-modal').style.display = 'flex'; document.getElementById('manual-code-input').value = ""; 
        html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().then(() => { document.getElementById('manual-code-input').value = decodedText; window.processScannedCode(); }).catch(()=>{}); } }, () => {}).catch(() => { document.getElementById('qr-reader').innerHTML = `<div style="color:red; padding:20px; text-align:center;">Fotocamera non disponibile.</div>`; });
    };
    window.closeScanner = function() { document.getElementById('scanner-modal').style.display = 'none'; if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(()=>{}); };

    window.processScannedCode = function() {
        let code = document.getElementById('manual-code-input').value.trim().toUpperCase(); if(!code) return; closeScanner();
        if (code.startsWith('A')) {
            if (!globalSettings.lockers_config || !globalSettings.lockers_config.enabled) return alert("Armadietti disattivati.");
            let num = parseInt(code.replace('A', '')) || 0;
            if (num >= 50 && globalSettings.keys_active) { if (!consumeKey(code)) return; }
            get(ref(db, `dmz_lockers/${code}`)).then((snap) => {
                let lockerData = snap.val(); if (!lockerData) { lockerData = generateLockerContent(); update(ref(db, `dmz_lockers/${code}`), lockerData); }
                openLockerUI(code, lockerData);
            });
        } 
        else if (code.startsWith('B')) {
            let baseExists = activeBases.find(b => b.id === code);
            if (!baseExists) return alert(`ERRORE: La base ${code} non √® presente nell'area operativa.`);
            if (globalSettings.keys_active) { if (!consumeKey(code)) return; }
            if (globalSettings.contracts_config && globalSettings.contracts_config.enabled) {
                let pool = globalSettings.contracts_config.pool;
                if (pool && pool.length > 0) {
                    let randomContract = pool[Math.floor(Math.random() * pool.length)];
                    if (confirm(`BASE ${code} SBLOCCATA.\nCONTRATTO DISPONIBILE: "${randomContract}".\nAccettare?`)) { document.getElementById('obj-status').innerText = `CONTRATTO: ${randomContract}`; document.getElementById('obj-status').style.color = "#ff0"; }
                }
            } else alert("Base sbloccata.");
        } 
        else if (code.startsWith('C')) {
            if (globalSettings.exfil_config && globalSettings.exfil_config.enabled) {
                let totalValue = 0; myBackpack.forEach(i => totalValue += (i.value||0)); myCash += totalValue; myBackpack = []; updateEconomyHUD();
                alert(`ESTRAZIONE EFFETTUATA!\nVenduto loot per $${totalValue}.\nCash: $${myCash}`); document.getElementById('obj-status').innerText = `‚úÖ ESTRATTO`; document.getElementById('obj-status').style.color = "#0f0";
            } else alert("Elicottero non disponibile.");
        } 
        else if (code.startsWith('D')) {
            if (!globalSettings.shop_config || !globalSettings.shop_config.enabled) return alert("Negozio chiuso.");
            const cont = document.getElementById('shop-items-container'); cont.innerHTML = ""; let pool = globalSettings.shop_config.pool || [];
            if(pool.length === 0) { cont.innerHTML = "<div style='color:#888;'>Negozio vuoto.</div>"; }
            pool.forEach((item, idx) => { cont.innerHTML += `<div class="shop-item"><span>${item.name}</span><div style="display:flex; align-items:center; gap:10px;"><span style="color:#8f8;">$${item.price}</span><button class="shop-btn" onclick="buyItem(${idx})">COMPRA</button></div></div>`; });
            document.getElementById('shop-modal').style.display = 'flex';
        }
        else if (code.startsWith('OP_')) {
            if (!globalSettings.economy_active) return;
            get(ref(db, 'dmz_players/' + code)).then((snap) => {
                let target = snap.val();
                if (target && target.status !== 'active') {
                    if (target.cash > 0) { myCash += target.cash; updateEconomyHUD(); update(ref(db, 'dmz_players/' + code), { cash: 0 }); alert(`Rubato $${target.cash}!`); } else alert("Senza soldi.");
                } else alert("Operatore attivo o non trovato.");
            });
        } else alert("Codice errato o non supportato.");
    };

    window.closeShop = function() { document.getElementById('shop-modal').style.display = 'none'; };
    window.buyItem = function(idx) {
        let item = globalSettings.shop_config.pool[idx];
        if (myCash >= item.price) {
            if (myBackpack.length >= 5) return alert("Zaino pieno!");
            let newItem = {name: item.name, value: Math.floor(item.price / 2)}; if (item.name.includes("CHIAVE")) newItem.uses = 3; myBackpack.push(newItem); myCash -= item.price; updateEconomyHUD(); alert(`Acquistato: ${item.name}`);
        } else alert("Fondi insufficienti!");
    };

    // -----------------------------------------------------------
    // DEPLOY, MAPPA & GESTIONE STREAKS (V21)
    // -----------------------------------------------------------
    window.deploy = function() {
        let n = document.getElementById('p-name').value.trim().toUpperCase(); if(!n) return; myName = n; myTeam = document.getElementById('p-team').value;
        activeFieldCenter = fieldsDB[globalSettings.activeField].center; activePlayAreaCoords = fieldsDB[globalSettings.activeField].boundaries; activeBases = masterBasesDB.filter(b => isInsideArea([b.lat, b.lng], activePlayAreaCoords));
        document.getElementById('login-screen').style.display = 'none'; document.getElementById('hud-top').style.display = 'flex'; document.getElementById('hud-status').style.display = 'flex'; document.getElementById('hud-bottom').style.display = 'flex'; document.getElementById('crosshair').style.display = 'block'; 
        isDeployed = true; document.getElementById('hud-economy-box').style.display = globalSettings.economy_active ? 'flex' : 'none'; updateEconomyHUD(); initMap(); startGPS(); setupNetworking();
    };

    window.setStatus = function(newStatus, btnElement) {
        myStatus = newStatus; update(ref(db, 'dmz_players/' + myId), { status: myStatus }); document.querySelectorAll('.btn-status').forEach(btn => { btn.style.borderColor = "#555"; btn.style.color = "#fff"; });
        if(!btnElement) btnElement = document.getElementById('btn-status-' + newStatus); btnElement.style.borderColor = (newStatus==='active')?"#0f0":(newStatus==='down')?"#ffa500":"#aaa"; btnElement.style.color = btnElement.style.borderColor;
        if (bleedoutTimer) { clearTimeout(bleedoutTimer); bleedoutTimer = null; }
        if (newStatus === 'down' && globalSettings.medic_active) bleedoutTimer = setTimeout(() => { window.setStatus('dead'); try { navigator.vibrate(1000); } catch(e){} }, (globalSettings.bleedout_time || 60) * 1000);
    };

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView(activeFieldCenter, 17); L.tileLayer('http://mt0.google.com/vt/lyrs=y&hl=it&x={x}&y={y}&z={z}', { attribution: '¬© Google', maxZoom: 20 }).addTo(map); L.polygon(activePlayAreaCoords, { color: 'red', fill: false, weight: 3, dashArray: '10, 10' }).addTo(map);
        activeBases.forEach(b => { L.marker([b.lat, b.lng], {icon: L.divIcon({ className: 'base-icon', html: `<div style="background:#ff0; color:#000; font-weight:900; padding:4px 8px; border-radius:4px; border:2px solid #000; text-align:center;">üö© ${b.id}</div>`, iconSize: [60, 30] }) }).addTo(map); });
        
        // EVENTO CLICK PER ATTACCO AEREO
        map.on('click', function(e) {
            if(isTargetingAirstrike) {
                isTargetingAirstrike = false; document.getElementById('targeting-overlay').style.display = 'none'; document.getElementById('map').style.cursor = '';
                // Consuma Oggetto
                myBackpack.splice(window.airstrikeIdxPending, 1); updateEconomyHUD();
                let strikeId = "STRK_" + Math.floor(Math.random()*9999);
                update(ref(db, `dmz_streaks/airstrikes/${strikeId}`), { lat: e.latlng.lat, lng: e.latlng.lng, timestamp: Date.now(), team: myTeam, sender: myName });
                alert("Attacco aereo in arrivo! Impatto tra 15 secondi.");
            }
        });
    }

    function startGPS() {
        if (!navigator.geolocation) return;
        navigator.geolocation.watchPosition((pos) => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude; document.getElementById('gps-status').innerText = `GPS: ¬±${Math.round(pos.coords.accuracy)}m`;
            update(ref(db, 'dmz_players/' + myId), { name: myName, team: myTeam, lat: lat, lng: lng, status: myStatus, lastUpdate: Date.now() });
            if (!myMarker) { myMarker = L.marker([lat, lng], {icon: L.divIcon({ className: 'my-icon', html: `<div style="width:20px; height:20px; background:cyan; border:3px solid white; border-radius:50%; box-shadow:0 0 15px cyan;"></div>`, iconSize: [20, 20] }) }).addTo(map); map.setView([lat, lng]); } else myMarker.setLatLng([lat, lng]);
        }, () => {}, { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
    }

    // GAME LOOP 1 SECONDO: GAS, AIRSTRIKES, EMP, CUAV
    setInterval(() => {
        if(!isDeployed || !map) return;
        let now = Date.now();
        
        // GESTIONE GAS
        if(globalSettings.gas_config && globalSettings.gas_config.enabled) {
            let conf = globalSettings.gas_config; let centerLL = L.latLng(activeFieldCenter[0], activeFieldCenter[1]);
            let stepsTaken = Math.floor(((now - conf.startTime) / 60000) / conf.interval); if(stepsTaken > conf.steps) stepsTaken = conf.steps;
            let maxR = 0; activePlayAreaCoords.forEach(p => { let d = centerLL.distanceTo(L.latLng(p[0], p[1])); if(d > maxR) maxR = d; });
            let currentRadius = maxR * (1 - (stepsTaken / conf.steps)); if(currentRadius < 10) currentRadius = 10;
            
            if(!window.safeZoneCircle) { window.safeZoneCircle = L.circle(centerLL, {color:'#0f0', weight:2, fillOpacity:0.1}).addTo(map); } else { window.safeZoneCircle.setRadius(currentRadius); }
            
            if(myMarker) {
                let inGas = centerLL.distanceTo(myMarker.getLatLng()) > currentRadius;
                if (inGas) {
                    document.getElementById('gas-overlay').style.display = 'block';
                    if (conf.lethal && myStatus === 'active') {
                        let maxTime = conf.survivalTime;
                        if(myBackpack.some(i => i.name.includes("AVANZATA"))) maxTime += 120; else if(myBackpack.some(i => i.name.includes("COMPLETA"))) maxTime += 60; else if(myBackpack.some(i => i.name.includes("SEMPLICE"))) maxTime += 30;
                        window.gasExposure = (window.gasExposure || 0) + 1; let remain = maxTime - window.gasExposure;
                        document.getElementById('obj-status').innerText = `‚ò¢Ô∏è GAS: ${remain}s`; document.getElementById('obj-status').style.color = "#f0f";
                        if (remain <= 0) { alert("Filtri esauriti. Sei a terra!"); setStatus('down'); }
                    } else if (!conf.lethal) { document.getElementById('obj-status').innerText = `‚ò¢Ô∏è ZONA CONTAMINATA`; document.getElementById('obj-status').style.color = "#f0f"; }
                } else {
                    document.getElementById('gas-overlay').style.display = 'none'; window.gasExposure = 0;
                    let os = document.getElementById('obj-status');
                    if (os.innerText.includes("‚ò¢Ô∏è")) {
                        if(globalSettings.uav_active || localUAVActive) { os.innerText = "‚ö†Ô∏è UAV ATTIVO"; os.style.color = "#f00"; } 
                        else { os.innerText = (globalSettings.exfil_config && globalSettings.exfil_config.enabled) ? "OBIETTIVO: ESTRAZIONE" : "OBIETTIVO: SOPRAVVIVENZA"; os.style.color = "#0f0"; }
                    }
                }
                if (window.lastGasStatus !== inGas) { window.lastGasStatus = inGas; update(ref(db, 'dmz_players/' + myId), { in_gas: inGas }); }
            }
        } else { document.getElementById('gas-overlay').style.display = 'none'; if(window.safeZoneCircle) { map.removeLayer(window.safeZoneCircle); window.safeZoneCircle = null; } }

        // GESTIONE ATTACCHI AEREI (HIT DETECTION)
        if(activeStreaks.airstrikes && myMarker && myStatus === 'active') {
            Object.keys(activeStreaks.airstrikes).forEach(k => {
                let s = activeStreaks.airstrikes[k];
                let age = now - s.timestamp;
                if (age > 15000 && age < 17000 && s.team !== myTeam) { // Finestra di 2 sec per l'impatto letale
                    let dist = myMarker.getLatLng().distanceTo([s.lat, s.lng]);
                    if (dist <= 40) { setStatus('down'); alert("‚ö†Ô∏è SEI STATO COLPITO DA UN ATTACCO AEREO! ‚ö†Ô∏è"); }
                }
            });
        }

        // GESTIONE EMP & CUAV
        let cuavOn = false, empOn = false;
        if(activeStreaks.cuav && activeStreaks.cuav.endTime > now && activeStreaks.cuav.team !== myTeam) cuavOn = true;
        if(activeStreaks.emp && activeStreaks.emp.endTime > now && activeStreaks.emp.team !== myTeam) empOn = true;
        document.getElementById('cuav-overlay').style.display = cuavOn ? 'block' : 'none';
        document.getElementById('emp-overlay').style.display = empOn ? 'flex' : 'none';

    }, 1000);

    function setupNetworking() {
        onValue(ref(db, 'dmz_players'), (snap) => {
            if(!isDeployed) return; const players = snap.val() || {}; let isUAV = globalSettings.uav_active || localUAVActive;
            Object.keys(markers).forEach(k => { 
                let p = players[k]; let isGasVis = p && p.in_gas && globalSettings.gas_config && globalSettings.gas_config.visibility;
                if(!p || (p.team !== myTeam && p.status !== "dead" && !isUAV && !isGasVis)) { map.removeLayer(markers[k]); delete markers[k]; } 
            });
            Object.keys(players).forEach(k => {
                if (k === myId) return; const p = players[k];
                let isGasVis = p.in_gas && globalSettings.gas_config && globalSettings.gas_config.visibility;
                if (p.team === myTeam || p.status === "dead" || isUAV || isGasVis) {
                    let c = (p.team===myTeam)?"#0f0":"#f00", s = ""; if(p.status==="down"){c="#ffa500";s="üè•";} else if(p.status==="dead"){c="#555";s="üíÄ";}
                    let ic = L.divIcon({ className:'custom-icon', html:`<div style="width:20px;height:20px;background:${c};border:2px solid #000;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:12px;">${s}</div><div class="teammate-label" style="color:${c};">${p.name}</div>`, iconSize:[20,20] });
                    if(!markers[k]) markers[k] = L.marker([p.lat, p.lng], {icon:ic}).addTo(map); else { markers[k].setIcon(ic); markers[k].setLatLng([p.lat, p.lng]); }
                }
            });
        });
        onChildAdded(ref(db, 'dmz_pings'), (snapshot) => {
            if(!isDeployed) return; const ping = snapshot.val();
            if (Date.now() - ping.timestamp <= 15000 && ping.team === myTeam) {
                let pingMarker = L.marker([ping.lat, ping.lng], {icon: L.divIcon({ className: 'custom-ping', html: `<div style="width:24px; height:24px;" class="ping-icon">‚ö†Ô∏è</div><div class="teammate-label" style="color:#ff0; margin-top:-35px; width:150px; margin-left:-65px;">PING: ${ping.sender}</div>`, iconSize: [24, 24] }) }).addTo(map);
                setTimeout(() => { if (map.hasLayer(pingMarker)) map.removeLayer(pingMarker); }, 10000);
            }
        });
        onDisconnect(ref(db, 'dmz_players/' + myId)).remove();
    }
    window.centerMap = function() { if(myMarker) map.setView(myMarker.getLatLng(), 18); };
</script>
</body>
</html>
