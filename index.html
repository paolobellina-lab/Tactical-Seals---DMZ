<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>DMZ: TACTICAL MAP - MASTER LOBBY</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* STILE MILITARE/DMZ */
    body { margin: 0; padding: 0; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: #0f0; }
    
    /* SCHERMATE (LOGIN / MASTER) */
    .full-screen-ui { position: absolute; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    h1 { color: #fff; text-shadow: 0 0 10px #0f0; font-size: 30px; letter-spacing: 2px; margin-bottom: 10px; text-align: center; }
    
    .status-label { font-size: 18px; font-weight: bold; margin-bottom: 20px; padding: 10px; border: 2px dashed #f00; color: #f00; text-align: center; width: 80%; max-width: 300px; }
    .status-label.running { border-color: #0f0; color: #0f0; }

    .input-box { background: #111; border: 1px solid #333; color: #0f0; padding: 12px; margin: 8px; width: 80%; max-width: 300px; text-align: center; font-size: 16px; font-weight: bold; text-transform: uppercase; }
    .input-box::placeholder { color: #040; }
    
    .btn-deploy { background: #004400; color: #fff; border: 2px solid #0f0; padding: 15px 40px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 0 15px #0f0; transition: 0.2s; width: 80%; max-width: 300px; }
    .btn-deploy:active { background: #0f0; color: #000; }
    .btn-deploy:disabled { background: #222; border-color: #555; color: #555; box-shadow: none; cursor: not-allowed; }

    .btn-master { background: #222; border: 1px solid #555; color: #aaa; padding: 10px; margin-top: 30px; font-size: 12px; cursor: pointer; width: 60%; max-width: 200px; }

    /* MAPPA E MIRINO CENTRALE */
    #map { height: 100vh; width: 100%; z-index: 1; background: #222; }
    #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(0, 255, 0, 0.5); font-size: 30px; font-weight: bold; z-index: 1000; pointer-events: none; text-shadow: 0 0 5px #000; display: none; }

    /* HUD (Interfaccia) */
    #hud-top { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; justify-content: space-between; pointer-events: none; }
    .hud-box { background: rgba(0, 20, 0, 0.9); border: 1px solid #0f0; padding: 5px 10px; color: #0f0; font-weight: bold; font-size: 12px; text-shadow: 0 0 5px #0f0; transition: 0.3s; }
    
    /* PULSANTI STATO */
    #hud-status { position: absolute; top: 50px; left: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 5px; }
    .btn-status { background: rgba(0,0,0,0.8); border: 1px solid #555; color: #fff; padding: 8px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; text-align: left; transition: 0.2s; }
    .btn-status:active { transform: scale(0.95); }

    /* PULSANTI AZIONE (Centro) */
    #hud-bottom { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 20px; }
    .action-btn { background: rgba(0,0,0,0.8); border: 2px solid #fff; color: #fff; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; backdrop-filter: blur(4px); box-shadow: 0 0 10px #000; }
    .action-btn:active { background: #fff; color: #000; }

    /* STILE MARKER E PING */
    .teammate-label { background: transparent; font-weight: bold; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; font-size: 12px; margin-top: -38px; text-align: center; width: 100px; margin-left: -42px; }
    .exfil-icon { text-align: center; font-size: 20px; text-shadow: 0 0 5px #0f0; }
    
    .ping-icon { background: rgba(255, 0, 0, 0.8); border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; box-shadow: 0 0 15px #f00; animation: ping-pulse 1s infinite; }
    @keyframes ping-pulse { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }

    /* AVVISO FUORI AREA */
    #out-of-bounds-warning { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 0, 0, 0.4); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; }
    .warning-text { color: #fff; background: #f00; padding: 20px; font-size: 30px; font-weight: bold; text-align: center; border: 4px solid #fff; box-shadow: 0 0 30px #f00; animation: flash 1s infinite; }
    @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
</head>
<body>

<div id="login-screen" class="full-screen-ui">
    <h1>DMZ: DEPLOY</h1>
    
    <div id="status-label" class="status-label">CONNESSIONE...</div>

    <input type="text" id="p-name" class="input-box" placeholder="NOME OPERATORE">
    
    <select id="p-team" class="input-box">
        <option value="ALPHA">SQUADRA ALPHA</option>
        <option value="BRAVO">SQUADRA BRAVO</option>
        <option value="CHARLIE">SQUADRA CHARLIE</option>
        <option value="DELTA">SQUADRA DELTA</option>
    </select>

    <button id="btn-deploy" class="btn-deploy" onclick="deploy()" style="display:none;">DISPIEGAMENTO</button>
    
    <button class="btn-master" onclick="openMasterPanel()">‚öôÔ∏è PANNELLO MASTER</button>
</div>

<div id="master-screen" class="full-screen-ui" style="display:none; z-index: 2500;">
    <h1 style="color: #ff0; text-shadow: 0 0 10px #ff0;">SISTEMA MASTER</h1>
    
    <label style="color:#aaa; font-size:12px; margin-top:20px;">CAMPO OPERATIVO:</label>
    <select id="m-field" class="input-box" style="border-color: #ff0; color: #ff0;">
        <option value="campo1">CAMPO 1: DMZ ORIGINALE</option>
        <option value="campo2">CAMPO 2: ZONA URBANA</option>
        <option value="campo3">CAMPO 3: COLLINA NORD</option>
        <option value="campo4">CAMPO 4: POLIGONO</option>
        <option value="campo5">CAMPO 5: TEST LOCALE</option>
    </select>

    <button class="btn-deploy" style="background:#004400; border-color:#0f0;" onclick="masterStartGame()">üöÄ AVVIA PARTITA</button>
    <button class="btn-deploy" style="background:#400; border-color:#f00; box-shadow: 0 0 15px #f00;" onclick="masterStopGame()">‚èπ TERMINA PARTITA</button>
    
    <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 20px; width: 80%; text-align: center;">
        <label style="color:#aaa; font-size:12px;">CONTROLLO IN GIOCO:</label><br>
        <button id="btn-toggle-uav" class="btn-deploy" style="background:#550; border-color:#ff0; box-shadow: 0 0 15px #ff0; margin-top: 10px;" onclick="masterToggleUAV()">üì° UAV: SPENTO</button>
    </div>

    <button class="btn-master" onclick="closeMasterPanel()">TORNA AL LOGIN</button>
</div>

<div id="map"></div>
<div id="crosshair">‚úõ</div>

<div id="hud-top" style="display:none;">
    <div class="hud-box" id="obj-status">OBIETTIVO: ESTRAZIONE</div>
    <div class="hud-box" id="gps-status">GPS: ATTESA...</div>
</div>

<div id="hud-status" style="display:none;">
    <button class="btn-status" style="border-color:#0f0; color:#0f0;" onclick="setStatus('active', this)">üü¢ IN COMBATTIMENTO</button>
    <button class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('down', this)">üü† DA RIANIMARE</button>
    <button class="btn-status" style="border-color:#555; color:#fff;" onclick="setStatus('dead', this)">üíÄ ELIMINATO</button>
</div>

<div id="out-of-bounds-warning">
    <div class="warning-text">‚ö†Ô∏è ATTENZIONE ‚ö†Ô∏è<br>SEI FUORI DALLA ZONA OPERATIVA</div>
</div>

<div id="hud-bottom" style="display:none;">
    <div class="action-btn" onclick="centerMap()">üìç</div> 
    <div class="action-btn" onclick="pingLocation()">‚ö†Ô∏è</div> 
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, update, set, onDisconnect, onValue, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // -----------------------------------------------------------
    // 1. CONFIGURAZIONE FIREBASE
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCggNlC5bOdGVBzUsfX8wO4ygkNzNcFFm0",
        authDomain: "softair-dmz.firebaseapp.com",
        databaseURL: "https://softair-dmz-default-rtdb.firebaseio.com",
        projectId: "softair-dmz",
        storageBucket: "softair-dmz.firebasestorage.app",
        messagingSenderId: "426944578042",
        appId: "1:426944578042:web:c11e7eddd49bbd3bc76443",
        measurementId: "G-8N023X8HSR"
    };

    // -----------------------------------------------------------
    // 2. DATABASE DEI CAMPI DA GIOCO (I 5 CAMPI)
    // -----------------------------------------------------------
    const fieldsDB = {
        "campo1": {
            center: [45.679141, 9.896634],
            boundaries: [
                [45.679223271161206, 9.892754719006636], [45.679053080947185, 9.894369628150011],
                [45.679488010465164, 9.894333540794852], [45.67994184635777, 9.897482162532492],
                [45.67979056813591, 9.89984588429542], [45.68035785935887, 9.902110365831659],
                [45.67821215309606, 9.903234794745936], [45.67863434946003, 9.896859606506366]
            ],
            exfils: [ { lat: 45.680000, lng: 9.896634, label: "EXFIL A" }, { lat: 45.678000, lng: 9.896634, label: "EXFIL B" } ]
        },
        "campo2": {
            center: [45.000000, 9.000000],
            boundaries: [ [45.001, 8.999], [45.001, 9.001], [44.999, 9.001], [44.999, 8.999] ],
            exfils: [ { lat: 45.0005, lng: 9.0005, label: "EXFIL URBANO" } ]
        },
        "campo3": {
            center: [45.100000, 9.100000],
            boundaries: [ [45.101, 9.099], [45.101, 9.101], [45.099, 9.101], [45.099, 9.099] ],
            exfils: [ { lat: 45.1005, lng: 9.1005, label: "EXFIL COLLINA" } ]
        },
        "campo4": {
            center: [45.200000, 9.200000],
            boundaries: [ [45.201, 9.199], [45.201, 9.201], [45.199, 9.201], [45.199, 9.199] ],
            exfils: [ { lat: 45.2005, lng: 9.2005, label: "EXFIL POLIGONO" } ]
        },
        "campo5": {
            center: [45.699417, 9.827667],
            boundaries: [ [45.701417, 9.825667], [45.701417, 9.829667], [45.697417, 9.829667], [45.697417, 9.825667] ],
            exfils: [ { lat: 45.699800, lng: 9.827667, label: "EXFIL TEST" } ]
        }
    };

    // Variabili Globali del Campo
    let activeFieldCenter = [];
    let activePlayAreaCoords = [];
    let activeExfilPoints = [];

    // Ray-Casting Algorithm
    function isInsideArea(point, polygon) {
        let x = point[0], y = point[1], inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
            let xi = polygon[i][0], yi = polygon[i][1];
            let xj = polygon[j][0], yj = polygon[j][1];
            let intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    // -----------------------------------------------------------
    // VARIABILI E INIZIALIZZAZIONE
    // -----------------------------------------------------------
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId = "OP_" + Math.floor(Math.random() * 99999);
    let myName = "", myTeam = "", myStatus = "active";
    let map, myMarker = null, markers = {}; 
    
    // Variabile di stato globale gestita dal Master
    let globalSettings = { status: 'lobby', activeField: 'campo1', uav_active: false };
    let isDeployed = false; // So se il giocatore √® sceso in campo

    // Wake Lock e Fullscreen
    let wakeLock = null;
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }
    function enableImmersiveMode() {
        if (!document.fullscreenElement) {
            try { document.documentElement.requestFullscreen().catch(e => {}); } catch(e) {}
        }
        if (wakeLock === null) requestWakeLock();
    }
    document.addEventListener('click', enableImmersiveMode);
    document.addEventListener('touchstart', enableImmersiveMode, {passive: true});
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock();
    });

    // -----------------------------------------------------------
    // LOBBY E ASCOLTO IMPOSTAZIONI MASTER
    // -----------------------------------------------------------
    onValue(ref(db, 'dmz_settings'), (snapshot) => {
        let data = snapshot.val();
        if(data) globalSettings = data;

        // AGGIORNA INTERFACCIA LOGIN
        const statusLabel = document.getElementById('status-label');
        const btnDeploy = document.getElementById('btn-deploy');
        
        if (globalSettings.status === 'running') {
            statusLabel.innerText = "üü¢ PARTITA IN CORSO";
            statusLabel.className = "status-label running";
            btnDeploy.style.display = "block";
        } else {
            statusLabel.innerText = "üî¥ IN ATTESA DEL MASTER";
            statusLabel.className = "status-label";
            btnDeploy.style.display = "none";

            // Se la partita viene fermata mentre sto giocando, mi butta fuori
            if (isDeployed) {
                alert("Il Game Master ha terminato la partita!");
                window.location.reload();
            }
        }

        // AGGIORNA INTERFACCIA PANNELLO MASTER
        const btnUav = document.getElementById('btn-toggle-uav');
        if (globalSettings.uav_active) {
            btnUav.innerText = "üì° UAV: ATTIVO";
            btnUav.style.background = "#900";
            btnUav.style.borderColor = "#f00";
            btnUav.style.boxShadow = "0 0 15px #f00";
        } else {
            btnUav.innerText = "üì° UAV: SPENTO";
            btnUav.style.background = "#550";
            btnUav.style.borderColor = "#ff0";
            btnUav.style.boxShadow = "0 0 15px #ff0";
        }

        // AGGIORNA HUD IN GIOCO SE SONO SCHIERATO
        if (isDeployed) {
            let objLabel = document.getElementById('obj-status');
            if(globalSettings.uav_active) {
                objLabel.innerText = "‚ö†Ô∏è UAV ATTIVO: NEMICI VISIBILI";
                objLabel.style.color = "#f00";
            } else {
                objLabel.innerText = "OBIETTIVO: ESTRAZIONE";
                objLabel.style.color = "#0f0";
            }
            // Forza l'aggiornamento dei marker sul radar simulando l'arrivo di nuovi dati
            getDatabase()._root && get(ref(db, 'dmz_players')); 
        }
    });

    // -----------------------------------------------------------
    // PANNELLO MASTER LOGICA
    // -----------------------------------------------------------
    window.openMasterPanel = function() {
        if (prompt("INSERISCI PIN MASTER:") === "0000") {
            document.getElementById('master-screen').style.display = 'flex';
        } else {
            alert("ACCESSO NEGATO");
        }
    };

    window.closeMasterPanel = function() {
        document.getElementById('master-screen').style.display = 'none';
    };

    window.masterStartGame = function() {
        let selectedField = document.getElementById('m-field').value;
        update(ref(db, 'dmz_settings'), {
            status: 'running',
            activeField: selectedField,
            uav_active: false
        });
        alert("SISTEMA ATTIVATO: La partita √® iniziata. I giocatori possono dispiegarsi.");
    };

    window.masterStopGame = function() {
        if(confirm("Sei sicuro di voler terminare la partita e azzerare la mappa?")) {
            update(ref(db, 'dmz_settings'), { status: 'lobby', uav_active: false });
            set(ref(db, 'dmz_players'), null); // Pulisce i marker
            set(ref(db, 'dmz_pings'), null);   // Pulisce i ping
        }
    };

    window.masterToggleUAV = function() {
        update(ref(db, 'dmz_settings'), {
            uav_active: !globalSettings.uav_active
        });
    };

    // -----------------------------------------------------------
    // LOGICA DI GIOCO GIOCATORE
    // -----------------------------------------------------------
    window.deploy = function() {
        let n = document.getElementById('p-name').value.trim().toUpperCase();
        if(!n) { alert("Inserisci nome operatore!"); return; }
        
        myName = n;
        myTeam = document.getElementById('p-team').value;

        // Legge il campo scelto dal Master su Firebase
        let selectedField = fieldsDB[globalSettings.activeField];
        activeFieldCenter = selectedField.center;
        activePlayAreaCoords = selectedField.boundaries;
        activeExfilPoints = selectedField.exfils;
        
        // UI Switch
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('hud-top').style.display = 'flex';
        document.getElementById('hud-status').style.display = 'flex';
        document.getElementById('hud-bottom').style.display = 'flex';
        document.getElementById('crosshair').style.display = 'block'; 
        
        isDeployed = true;

        initMap();
        startGPS();
        setupNetworking();
    };

    window.setStatus = function(newStatus, btnElement) {
        myStatus = newStatus;
        update(ref(db, 'dmz_players/' + myId), { status: myStatus });

        let buttons = document.querySelectorAll('.btn-status');
        buttons.forEach(btn => { btn.style.borderColor = "#555"; btn.style.color = "#fff"; });
        
        if(newStatus === 'active') { btnElement.style.borderColor = "#0f0"; btnElement.style.color = "#0f0"; }
        if(newStatus === 'down') { btnElement.style.borderColor = "#ffa500"; btnElement.style.color = "#ffa500"; }
        if(newStatus === 'dead') { btnElement.style.borderColor = "#aaa"; btnElement.style.color = "#aaa"; }
    };

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView(activeFieldCenter, 17);
        L.tileLayer('http://mt0.google.com/vt/lyrs=y&hl=it&x={x}&y={y}&z={z}', { attribution: '¬© Google', maxZoom: 20 }).addTo(map);
        L.polygon(activePlayAreaCoords, { color: 'red', fill: false, weight: 3, dashArray: '10, 10' }).addTo(map);

        activeExfilPoints.forEach(ex => {
            let icon = L.divIcon({
                className: 'exfil-icon',
                html: `<div style="background:#0f0; color:#000; font-weight:900; padding:4px 8px; border-radius:4px; border:2px solid #fff; font-family:sans-serif;">üöÅ ${ex.label}</div>`,
                iconSize: [80, 30]
            });
            L.marker([ex.lat, ex.lng], {icon: icon}).addTo(map);
        });
    }

    function startGPS() {
        if (!navigator.geolocation) { 
            document.getElementById('gps-status').innerText = "GPS: ERROR"; return; 
        }
        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude, lng = pos.coords.longitude, acc = Math.round(pos.coords.accuracy);
                document.getElementById('gps-status').innerText = `GPS: ¬±${acc}m`;

                let amI_Inside = isInsideArea([lat, lng], activePlayAreaCoords);
                document.getElementById('out-of-bounds-warning').style.display = amI_Inside ? 'none' : 'flex';

                update(ref(db, 'dmz_players/' + myId), {
                    name: myName, team: myTeam, lat: lat, lng: lng, status: myStatus, lastUpdate: Date.now()
                });
                updateMyMarker(lat, lng);
            },
            (err) => { document.getElementById('gps-status').innerText = "GPS: NO SEG"; },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
    }

    function updateMyMarker(lat, lng) {
        if (!myMarker) {
            let myIcon = L.divIcon({
                className: 'my-icon',
                html: `<div style="width:20px; height:20px; background:cyan; border:3px solid white; border-radius:50%; box-shadow:0 0 15px cyan;"></div>`,
                iconSize: [20, 20]
            });
            myMarker = L.marker([lat, lng], {icon: myIcon}).addTo(map);
            map.setView([lat, lng]); 
        } else {
            myMarker.setLatLng([lat, lng]);
        }
    }

    function setupNetworking() {
        onValue(ref(db, 'dmz_players'), (snapshot) => {
            if(!isDeployed) return;
            const players = snapshot.val() || {};
            let isUAV = globalSettings.uav_active;
            
            Object.keys(markers).forEach(key => {
                const p = players[key];
                let shouldBeVisible = false;
                if (p) {
                    if (p.team === myTeam) shouldBeVisible = true;
                    else if (p.status === "dead") shouldBeVisible = true;
                    else if (isUAV) shouldBeVisible = true;
                }
                if (!shouldBeVisible) {
                    map.removeLayer(markers[key]);
                    delete markers[key];
                }
            });

            Object.keys(players).forEach(key => {
                if (key === myId) return; 
                const p = players[key];
                let isVisible = false, dotColor = (p.team === myTeam) ? "#0f0" : "#f00", iconSymbol = "";

                if (p.team === myTeam) isVisible = true; 
                else if (p.status === "dead") isVisible = true; 
                else if (isUAV) isVisible = true; 

                if (isVisible) {
                    if (p.status === "down") { dotColor = "#ffa500"; iconSymbol = "üè•"; } 
                    else if (p.status === "dead") { dotColor = "#555555"; iconSymbol = "üíÄ"; }

                    let iconHtml = `<div style="width:20px; height:20px; background:${dotColor}; border:2px solid #000; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:12px;">${iconSymbol}</div><div class="teammate-label" style="color:${dotColor};">${p.name}</div>`;
                    let pIcon = L.divIcon({ className: 'custom-icon', html: iconHtml, iconSize: [20, 20] });

                    if (!markers[key]) markers[key] = L.marker([p.lat, p.lng], {icon: pIcon}).addTo(map);
                    else { markers[key].setIcon(pIcon); markers[key].setLatLng([p.lat, p.lng]); }
                }
            });
        });

        onChildAdded(ref(db, 'dmz_pings'), (snapshot) => {
            if(!isDeployed) return;
            const ping = snapshot.val(), now = Date.now();
            if (now - ping.timestamp > 15000) return;
            
            if (ping.team === myTeam) {
                let pIcon = L.divIcon({
                    className: 'custom-ping',
                    html: `<div style="width:24px; height:24px;" class="ping-icon">‚ö†Ô∏è</div><div class="teammate-label" style="color:#ff0; text-shadow: 0 0 5px #000; margin-top:-35px; width:150px; margin-left:-65px;">PING: ${ping.sender}</div>`,
                    iconSize: [24, 24]
                });
                let pingMarker = L.marker([ping.lat, ping.lng], {icon: pIcon}).addTo(map);
                setTimeout(() => { if (map.hasLayer(pingMarker)) map.removeLayer(pingMarker); }, 10000);
            }
        });

        onDisconnect(ref(db, 'dmz_players/' + myId)).remove();
    }

    window.centerMap = function() { if(myMarker) map.setView(myMarker.getLatLng(), 18); };
    
    window.pingLocation = function() {
        if (!map) return;
        const center = map.getCenter();
        update(push(ref(db, 'dmz_pings')), { team: myTeam, lat: center.lat, lng: center.lng, sender: myName, timestamp: Date.now() });

        let objLabel = document.getElementById('obj-status');
        objLabel.innerText = "PING INVIATO!";
        objLabel.style.color = "#ff0";
        setTimeout(() => { 
            objLabel.innerText = globalSettings.uav_active ? "‚ö†Ô∏è UAV ATTIVO: NEMICI VISIBILI" : "OBIETTIVO: ESTRAZIONE"; 
            objLabel.style.color = globalSettings.uav_active ? "#f00" : "#0f0";
        }, 2000);
    };

</script>
</body>
</html>
