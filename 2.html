<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>DMZ: TACTICAL MAP</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* STILE MILITARE/DMZ */
    body { margin: 0; padding: 0; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: #0f0; }
    
    /* LOGIN SCREEN */
    #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    h1 { color: #fff; text-shadow: 0 0 10px #0f0; font-size: 30px; letter-spacing: 2px; margin-bottom: 30px; }
    .input-box { background: #111; border: 1px solid #333; color: #0f0; padding: 15px; margin: 10px; width: 80%; text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; }
    .input-box::placeholder { color: #040; }
    .btn-deploy { background: #004400; color: #fff; border: 2px solid #0f0; padding: 15px 40px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 0 15px #0f0; transition: 0.2s; }
    .btn-deploy:active { background: #0f0; color: #000; }

    /* MAPPA */
    #map { height: 100vh; width: 100%; z-index: 1; background: #222; }

    /* HUD (Interfaccia) */
    #hud-top { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; justify-content: space-between; pointer-events: none; }
    .hud-box { background: rgba(0, 20, 0, 0.9); border: 1px solid #0f0; padding: 5px 10px; color: #0f0; font-weight: bold; font-size: 12px; text-shadow: 0 0 5px #0f0; }
    
    #hud-bottom { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 20px; }
    .action-btn { background: rgba(0,0,0,0.8); border: 2px solid #fff; color: #fff; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; backdrop-filter: blur(4px); box-shadow: 0 0 10px #000; }
    .action-btn:active { background: #fff; color: #000; }

    /* STILE MARKER MAPPA */
    .teammate-label { background: transparent; color: #0f0; font-weight: bold; text-shadow: 2px 2px 0 #000; font-size: 12px; margin-top: -40px; text-align: center; width: 100px; margin-left: -50px; }
    .exfil-icon { text-align: center; font-size: 20px; text-shadow: 0 0 5px #0f0; }
</style>
</head>
<body>

<div id="login-screen">
    <h1>DMZ: DEPLOY</h1>
    <input type="text" id="p-name" class="input-box" placeholder="NOME OPERATORE">
    <select id="p-team" class="input-box">
        <option value="ALPHA">SQUADRA ALPHA</option>
        <option value="BRAVO">SQUADRA BRAVO</option>
        <option value="CHARLIE">SQUADRA CHARLIE</option>
        <option value="DELTA">SQUADRA DELTA</option>
    </select>
    <button class="btn-deploy" onclick="deploy()">DISPIEGAMENTO</button>
</div>

<div id="map"></div>

<div id="hud-top" style="display:none;">
    <div class="hud-box" id="obj-status">OBIETTIVO: ESTRAZIONE</div>
    <div class="hud-box" id="gps-status">GPS: ATTESA...</div>
</div>

<div id="hud-bottom" style="display:none;">
    <div class="action-btn" onclick="centerMap()">üìç</div> <div class="action-btn" onclick="pingLocation()">‚ö†Ô∏è</div> </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, update, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // -----------------------------------------------------------
    // 1. CONFIGURAZIONE FIREBASE
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCggNlC5bOdGVBzUsfX8wO4ygkNzNcFFm0",
        authDomain: "softair-dmz.firebaseapp.com",
        databaseURL: "https://softair-dmz-default-rtdb.firebaseio.com",
        projectId: "softair-dmz",
        storageBucket: "softair-dmz.firebasestorage.app",
        messagingSenderId: "426944578042",
        appId: "1:426944578042:web:c11e7eddd49bbd3bc76443",
        measurementId: "G-8N023X8HSR"
    };
    
    // -----------------------------------------------------------
    // 2. CONFIGURAZIONE CAMPO DA GIOCO
    // -----------------------------------------------------------
    
    // Centro esatto del tuo campo
    const fieldCenter = [45.679141, 9.896634]; 

    // Confini del campo con gli 8 punti precisi forniti
    const playAreaCoords = [
        [45.679223271161206, 9.892754719006636],
        [45.679053080947185, 9.894369628150011],
        [45.679488010465164, 9.894333540794852],
        [45.67994184635777, 9.897482162532492],
        [45.67979056813591, 9.89984588429542],
        [45.68035785935887, 9.902110365831659],
        [45.67821215309606, 9.903234794745936],
        [45.67863434946003, 9.896859606506366]
    ];

    // Punti di Estrazione
    const exfilPoints = [
        { lat: 45.680000, lng: 9.896634, label: "EXFIL A" }, // Nord approssimativo
        { lat: 45.678000, lng: 9.896634, label: "EXFIL B" }  // Sud approssimativo
    ];

    // -----------------------------------------------------------
    // FINE CONFIGURAZIONE
    // -----------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId = "OP_" + Math.floor(Math.random() * 99999);
    let myName = "";
    let myTeam = "";
    let map;
    let myMarker = null;
    let markers = {}; 

    // WAKE LOCK (Schermo Sempre Acceso)
    let wakeLock = null;
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock();
    });

    // AVVIO GIOCO
    window.deploy = function() {
        let n = document.getElementById('p-name').value.trim().toUpperCase();
        if(!n) { alert("Inserisci nome operatore!"); return; }
        
        myName = n;
        myTeam = document.getElementById('p-team').value;
        
        // UI Switch
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('hud-top').style.display = 'flex';
        document.getElementById('hud-bottom').style.display = 'flex';
        
        // Attiva schermo intero e wake lock
        requestWakeLock();
        try { document.documentElement.requestFullscreen(); } catch(e){}

        initMap();
        startGPS();
        setupNetworking();
    };

    function initMap() {
        // Mappa Satellitare (ESRI World Imagery - Gratuito)
        map = L.map('map', { zoomControl: false }).setView(fieldCenter, 17); // Ho messo zoom 17 per vedere tutto il poligono
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        }).addTo(map);

        // Disegna la Zona Operativa (Poligono Rosso)
        L.polygon(playAreaCoords, { color: 'red', fill: false, weight: 3, dashArray: '10, 10' }).addTo(map);

        // Aggiungi Punti di Estrazione (Icona Elicottero)
        exfilPoints.forEach(ex => {
            let icon = L.divIcon({
                className: 'exfil-icon',
                html: `<div style="background:#0f0; color:#000; font-weight:900; padding:4px 8px; border-radius:4px; border:2px solid #fff; font-family:sans-serif;">üöÅ ${ex.label}</div>`,
                iconSize: [80, 30]
            });
            L.marker([ex.lat, ex.lng], {icon: icon}).addTo(map);
        });
    }

    function startGPS() {
        if (!navigator.geolocation) { 
            document.getElementById('gps-status').innerText = "GPS: ERROR";
            return; 
        }

        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const acc = Math.round(pos.coords.accuracy);

                document.getElementById('gps-status').innerText = `GPS: ¬±${acc}m`;

                // Salva su Firebase
                update(ref(db, 'dmz_players/' + myId), {
                    name: myName,
                    team: myTeam,
                    lat: lat,
                    lng: lng,
                    lastUpdate: Date.now()
                });

                // Aggiorna me stesso sulla mappa
                updateMyMarker(lat, lng);
            },
            (err) => {
                console.error(err);
                document.getElementById('gps-status').innerText = "GPS: NO SEG";
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
    }

    function updateMyMarker(lat, lng) {
        if (!myMarker) {
            // Icona Giocatore (Pallino Ciano)
            let myIcon = L.divIcon({
                className: 'my-icon',
                html: `<div style="width:20px; height:20px; background:cyan; border:3px solid white; border-radius:50%; box-shadow:0 0 15px cyan;"></div>`,
                iconSize: [20, 20]
            });
            myMarker = L.marker([lat, lng], {icon: myIcon}).addTo(map);
            map.setView([lat, lng]); // Primo centro automatico
        } else {
            myMarker.setLatLng([lat, lng]);
        }
    }

    function setupNetworking() {
        // Ascolta gli altri giocatori
        onValue(ref(db, 'dmz_players'), (snapshot) => {
            const players = snapshot.val() || {};
            
            Object.keys(players).forEach(key => {
                if (key === myId) return; // Ignora me stesso

                const p = players[key];
                
                // LOGICA SQUADRA: Mostra solo se √® del mio team
                if (p.team === myTeam) {
                    if (!markers[key]) {
                        // Crea marker compagno
                        let iconHtml = `
                            <div style="width:14px; height:14px; background:#0f0; border:2px solid #000; border-radius:50%;"></div>
                            <div class="teammate-label">${p.name}</div>
                        `;
                        let pIcon = L.divIcon({ className: 'custom-icon', html: iconHtml, iconSize: [14, 14] });
                        markers[key] = L.marker([p.lat, p.lng], {icon: pIcon}).addTo(map);
                    } else {
                        // Aggiorna posizione
                        markers[key].setLatLng([p.lat, p.lng]);
                    }
                }
            });
        });

        // Rimuovi me stesso dal database se chiudo l'app
        onDisconnect(ref(db, 'dmz_players/' + myId)).remove();
    }

    window.centerMap = function() {
        if(myMarker) map.setView(myMarker.getLatLng(), 18);
    };
    
    window.pingLocation = function() {
        alert("Ping Tattico: In arrivo nelle prossime versioni!");
    };

</script>
</body>
</html>